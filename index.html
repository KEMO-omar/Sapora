<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket - KAREEM OMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a; 
            --glass: rgba(255, 255, 255, 0.95); --shadow: 0 10px 30px rgba(0,0,0,0.15); 
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Cairo', sans-serif; 
            background: #f8fafc; touch-action: none; user-select: none; 
        }

        /* ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ ÙƒØ±ÙŠÙ… Ø¹Ù…Ø± */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a 0%, #4361ee 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: white; padding: 40px; border-radius: 30px; width: 100%; max-width: 500px; text-align: center; box-shadow: var(--shadow); border: 5px solid var(--primary); }
        .welcome-msg h1 { color: var(--primary); margin-bottom: 5px; font-size: 28px; }
        .welcome-msg h2 { color: #333; margin-bottom: 15px; font-size: 20px; }
        .welcome-msg p { color: #64748b; font-size: 15px; margin-bottom: 25px; line-height: 1.6; }

        /* ØªÙˆØ¨ Ø¨Ø§Ø± */
        .top-bar { position: fixed; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge { background: var(--glass); padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: bold; pointer-events: auto; box-shadow: var(--shadow); display: inline-flex; align-items: center; gap: 6px; border: 1px solid #eee; margin: 2px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠ */
        #main-toolbar { 
            position: fixed; background: var(--glass); padding: 12px; border-radius: 25px; 
            box-shadow: var(--shadow); display: none; gap: 10px; align-items: center; 
            z-index: 2000; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid #fff; bottom: 20px; left: 50%; transform: translateX(-50%);
        }
        
        .toolbar-vertical { flex-direction: column !important; width: 55px !important; border-radius: 30px !important; padding: 20px 8px !important; height: auto; max-height: 90vh; overflow-y: auto; }
        .toolbar-vertical #teacher-controls { flex-direction: column !important; }
        .toolbar-vertical .page-controls { flex-direction: column !important; }

        .tool-btn { width: 42px; height: 42px; border-radius: 12px; border: none; background: #f1f5f9; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .tool-btn:hover { background: #e2e8f0; transform: scale(1.1); }
        .tool-btn.active { background: var(--primary); color: white; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© */
        .sub-menu { position: absolute; background: white; padding: 15px; border-radius: 15px; display: none; gap: 10px; box-shadow: var(--shadow); z-index: 2001; min-width: 120px; }
        .pos-bottom .sub-menu { bottom: 65px; left: 50%; transform: translateX(-50%); }
        .pos-top .sub-menu { top: 65px; left: 50%; transform: translateX(-50%); }
        .pos-right .sub-menu { right: 65px; top: 0; }
        .pos-left .sub-menu { left: 65px; top: 0; }
        .show-menu { display: flex !important; flex-direction: column; align-items: center; }

        .color-grid { display: grid !important; grid-template-columns: repeat(5, 1fr) !important; width: 180px; gap: 8px; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.1); }

        /* Ø´Ø±ÙŠØ· Ø³Ù…Ùƒ Ø§Ù„Ø®Ø· */
        .thickness-box { width: 100%; text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .thickness-slider { width: 100px; cursor: pointer; }

        /* Ø´Ø§Øª ÙˆÙ…ØªØµÙ„ÙŠÙ† */
        #chat-panel { position: fixed; bottom: 90px; right: 20px; width: 300px; height: 400px; background: white; border-radius: 20px; box-shadow: var(--shadow); display: none; flex-direction: column; z-index: 2500; overflow: hidden; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; background: #f8fafc; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 13px; max-width: 85%; line-height: 1.4; }
        .msg-me { background: var(--primary); color: white; align-self: flex-end; }
        .msg-them { background: #e2e8f0; color: #333; align-self: flex-start; }

        #users-panel { position: absolute; top: 45px; left: 0; background: white; width: 170px; border-radius: 12px; box-shadow: var(--shadow); display: none; padding: 10px; z-index: 2005; }
        .user-row { font-size: 13px; padding: 6px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© */
        .geo-tool { position: absolute; background: rgba(255,255,255,0.3); border: 2px solid var(--primary); backdrop-filter: blur(5px); cursor: move; display: none; z-index: 500; }
        .ruler { height: 60px; width: 350px; background-image: linear-gradient(90deg, #333 1px, transparent 1px); background-size: 20px 20px; background-position: bottom; }
        .protractor { width: 240px; height: 120px; border-radius: 120px 120px 0 0; border-bottom: 2px solid #333; }
        .triangle { width: 180px; height: 180px; clip-path: polygon(0% 100%, 100% 100%, 0% 0%); background: rgba(67, 97, 238, 0.15); }
        .circle-tool { width: 180px; height: 180px; border-radius: 50%; border: 2px dashed var(--primary); }
        
        .zoom-controls { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        #board { background: white; cursor: crosshair; }
        #restore-btn { position: fixed; bottom: 20px; left: 20px; z-index: 3000; display: none; width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 22px; cursor: pointer; box-shadow: var(--shadow); }
    </style>
</head>
<body class="pos-bottom">

    <div id="auth-screen">
        <div class="card">
            <div class="welcome-msg">
                <h1>ğŸš€ MONSTER ELITE ULTIMATE</h1>
                <h2>Ø¨Ø¥Ø´Ø±Ø§Ù: ÙƒØ±ÙŠÙ… Ø¹Ù…Ø±</h2>
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø³Ø¨ÙˆØ±Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ØªØ¯Ø¹Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØŒ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø³Ù…Ùƒ Ø§Ù„Ø®Ø·. Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.</p>
            </div>
            <input type="text" id="userName" style="width:85%; padding:15px; margin-bottom:20px; border-radius:15px; border:2px solid #eee; text-align:center; outline:none; font-size:16px;" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button onclick="rocket.login('student')" style="background:#10b981; color:white; padding:15px; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:16px;">Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨ ğŸ“</button>
                <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; padding:15px; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:16px;">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¹Ù„Ù… ğŸ‘¨â€ğŸ«</button>
            </div>
        </div>
    </div>

    <button id="restore-btn" onclick="rocket.toggleMinimize()">ğŸš€</button>

    <div class="top-bar">
        <div>
            <div class="badge">ğŸ” <span id="zoom-info">100%</span></div>
            <button class="badge" onclick="rocket.toggleFullscreen()" style="cursor:pointer; border:none;">ğŸ–¥ï¸ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
        </div>
        <div>
            <div class="badge">â³ <span id="timer">00:00</span></div>
            <div style="position:relative; display:inline-block; pointer-events:auto;">
                <button class="badge" onclick="rocket.toggleUsers()" style="cursor:pointer; border:none;">ğŸ‘¥ <span id="user-count">0</span></button>
                <div id="users-panel">
                    <div style="font-weight:bold; font-size:11px; border-bottom:1px solid #eee; margin-bottom:5px;">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù†:</div>
                    <div id="users-list"></div>
                </div>
            </div>
            <button class="badge" onclick="rocket.toggleChat()" style="cursor:pointer; border:none;">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
    </div>

    <div id="chat-panel">
        <div style="background:var(--primary); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
            ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© <span onclick="rocket.toggleChat()" style="cursor:pointer; font-size:20px;">Ã—</span>
        </div>
        <div id="chat-msgs"></div>
        <div style="padding:10px; display:flex; gap:8px; border-top:1px solid #eee;">
            <input type="text" id="chat-input" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd; outline:none;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="if(event.key==='Enter') rocket.sendMsg()">
            <button onclick="rocket.sendMsg()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:10px; cursor:pointer;">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="tool-btn" onclick="rocket.adjustZoom(1.1)">â•</button>
        <button class="tool-btn" onclick="rocket.adjustZoom(0.9)">â–</button>
        <button class="tool-btn" onclick="rocket.resetZoom()">ğŸ </button>
    </div>

    <div id="tool-ruler" class="geo-tool ruler"><div style="position:absolute;right:0;bottom:0;width:15px;height:15px;cursor:nwse-resize;background:var(--primary);border-radius:50%;"></div></div>
    <div id="tool-protractor" class="geo-tool protractor"><div style="position:absolute;right:0;bottom:0;width:15px;height:15px;cursor:nwse-resize;background:var(--primary);border-radius:50%;"></div></div>
    <div id="tool-triangle" class="geo-tool triangle"><div style="position:absolute;right:0;bottom:0;width:15px;height:15px;cursor:nwse-resize;background:var(--primary);border-radius:50%;"></div></div>
    <div id="tool-circle" class="geo-tool circle-tool"><div style="position:absolute;right:0;bottom:0;width:15px;height:15px;cursor:nwse-resize;background:var(--primary);border-radius:50%;"></div></div>

    <div id="main-toolbar">
        <button class="tool-btn" onclick="rocket.toggleMinimize()">ğŸ“¦</button>
        
        <div id="teacher-controls" style="display:none; align-items:center; gap:8px;">
            <div style="position:relative;">
                <button class="tool-btn" onclick="rocket.toggleSubMenu('color-menu')">ğŸ¨</button>
                <div id="color-menu" class="sub-menu color-grid">
                    <div class="color-dot" style="background:#000000" onclick="rocket.updateColor('#000000')"></div>
                    <div class="color-dot" style="background:#ff0000" onclick="rocket.updateColor('#ff0000')"></div>
                    <div class="color-dot" style="background:#00b7ff" onclick="rocket.updateColor('#00b7ff')"></div>
                    <div class="color-dot" style="background:#2ed573" onclick="rocket.updateColor('#2ed573')"></div>
                    <div class="color-dot" style="background:#ffa500" onclick="rocket.updateColor('#ffa500')"></div>
                    <div class="color-dot" style="background:#800080" onclick="rocket.updateColor('#800080')"></div>
                    <div class="color-dot" style="background:#ffc0cb" onclick="rocket.updateColor('#ffc0cb')"></div>
                    <div class="color-dot" style="background:#a52a2a" onclick="rocket.updateColor('#a52a2a')"></div>
                    <div class="color-dot" style="background:#7f8c8d" onclick="rocket.updateColor('#7f8c8d')"></div>
                    <div class="color-dot" style="background:#1abc9c" onclick="rocket.updateColor('#1abc9c')"></div>
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn active" id="btn-pen" onclick="rocket.toggleSubMenu('pen-menu')">âœï¸</button>
                <div id="pen-menu" class="sub-menu">
                    <div style="display:flex; gap:8px;">
                        <button class="tool-btn" onclick="rocket.setMode('pen', 'âœï¸')">âœï¸</button>
                        <button class="tool-btn" onclick="rocket.setMode('marker', 'ğŸ–ï¸')">ğŸ–ï¸</button>
                        <button class="tool-btn" onclick="rocket.setMode('neon', 'ğŸŒŸ')">ğŸŒŸ</button>
                        <button class="tool-btn" onclick="rocket.setMode('brush', 'ğŸ–Œï¸')">ğŸ–Œï¸</button>
                    </div>
                    <div class="thickness-box">
                        <span style="font-size:12px; font-weight:bold;">Ø§Ù„Ø³Ù…Ùƒ</span><br>
                        <input type="range" class="thickness-slider" min="1" max="50" value="3" oninput="rocket.updateThickness(this.value)">
                    </div>
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn" onclick="rocket.toggleSubMenu('geo-menu')">ğŸ“</button>
                <div id="geo-menu" class="sub-menu">
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-ruler')">ğŸ“</button>
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-protractor')">ğŸ§­</button>
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-triangle')">ğŸ“</button>
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-circle')">â­•</button>
                </div>
            </div>

            <button class="tool-btn" onclick="rocket.setMode('eraser')">ğŸ§½</button>
            <button class="tool-btn" onclick="rocket.undo()">â†©ï¸</button>
            <button class="tool-btn" onclick="rocket.redo()">â†ªï¸</button>
            <button class="tool-btn" onclick="rocket.clearBoard()" style="color:red">ğŸ—‘ï¸</button>
            
            <select onchange="rocket.moveToolbar(this.value)" style="border-radius:12px; padding:8px; border:2px solid #eee; font-family:'Cairo'; outline:none; background:white; cursor:pointer;">
                <option value="bottom">Ø§Ù„ÙˆØ¶Ø¹: Ø£Ø³ÙÙ„</option>
                <option value="top">Ø§Ù„ÙˆØ¶Ø¹: Ø£Ø¹Ù„Ù‰</option>
                <option value="right">Ø§Ù„ÙˆØ¶Ø¹: ÙŠÙ…ÙŠÙ†</option>
                <option value="left">Ø§Ù„ÙˆØ¶Ø¹: ÙŠØ³Ø§Ø±</option>
            </select>
        </div>

        <button class="tool-btn" onclick="rocket.setMode('move')" id="btn-move">ğŸ–ï¸</button>

        <div class="page-controls" style="display:flex; align-items:center; background:#f1f5f9; padding:5px; border-radius:15px; gap:8px;">
            <button class="tool-btn" style="width:30px; height:30px; font-size:14px;" onclick="rocket.changePage(-1)">â—€</button>
            <span id="page-label" style="font-weight:bold; min-width:30px; text-align:center;">1</span>
            <button class="tool-btn" style="width:30px; height:30px; font-size:14px;" onclick="rocket.changePage(1)">â–¶</button>
        </div>
    </div>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onChildRemoved, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            isAdmin: false, mode: 'move', canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'), camera: { x: 0, y: 0, zoom: 1 },
            drawings: {}, redoStack: [], currentColor: '#000', currentThickness: 3, currentPage: 1, isDrawing: false,
            isDragging: false, currentPath: [], lastMouse: {x:0, y:0}, userName: '',

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.setupEvents();
                this.syncData();
                this.render();
                this.startTimer();
                this.syncUsers();
                this.syncChat();
                document.querySelectorAll('.geo-tool').forEach(t => { this.makeDraggable(t); this.makeResizable(t); });
            },

            login(role) {
                const name = document.getElementById('userName').value.trim();
                if(!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¨Ø·Ù„!");
                if(role === 'teacher' && prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒØ±ÙŠÙ… Ø¹Ù…Ø±:") !== "123") return;
                this.userName = name;
                this.isAdmin = (role === 'teacher');

                const userRef = push(ref(db, 'online_users'));
                set(userRef, { name: name, role: role });
                onDisconnect(userRef).remove();

                if(this.isAdmin) document.getElementById('teacher-controls').style.display = 'flex';
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-toolbar').style.display = 'flex';
                this.sendSystemMsg(`Ø§Ù†Ø¶Ù… ${name} Ø¥Ù„Ù‰ Ø±Ø­Ù„Ø© ÙƒØ±ÙŠÙ… Ø¹Ù…Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ğŸš€`);
            },

            setupEvents() {
                const getPos = (e) => {
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    return { x: (clientX - this.camera.x) / this.camera.zoom, y: (clientY - this.camera.y) / this.camera.zoom };
                };

                this.canvas.onpointerdown = (e) => {
                    if(e.target.closest('.tool-btn, .sub-menu, .badge, select, input')) return;
                    
                    // Ù…Ù†Ø¹ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¨Ø¹ÙŠÙ† (Ù„Ù„ØªÙƒØ¨ÙŠØ±)
                    if (e.pointerType === 'touch' && !e.isPrimary) return;

                    const pos = getPos(e);
                    if(this.mode === 'move' || !this.isAdmin) {
                        this.isDragging = true;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    } else {
                        this.isDrawing = true;
                        this.currentPath = [{x: pos.x, y: pos.y}];
                    }
                };

                window.onpointermove = (e) => {
                    if(this.isDragging) {
                        this.camera.x += e.clientX - this.lastMouse.x;
                        this.camera.y += e.clientY - this.lastMouse.y;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    } else if(this.isDrawing) {
                        const pos = getPos(e);
                        this.currentPath.push({x: pos.x, y: pos.y});
                    }
                };

                window.onpointerup = () => {
                    if(this.isDrawing && this.currentPath.length > 1) {
                        push(ref(db, 'board_data'), {
                            points: this.currentPath, color: this.currentColor,
                            thickness: this.currentThickness,
                            mode: this.mode, page: this.currentPage, time: Date.now()
                        });
                    }
                    this.isDrawing = this.isDragging = false;
                };

                window.onwheel = (e) => {
                    e.preventDefault();
                    this.adjustZoom(e.deltaY > 0 ? 0.9 : 1.1, e.clientX, e.clientY);
                };
            },

            syncData() {
                onChildAdded(ref(db, 'board_data'), (s) => this.drawings[s.key] = s.val());
                onChildRemoved(ref(db, 'board_data'), (s) => delete this.drawings[s.key]);
            },

            syncUsers() {
                onValue(ref(db, 'online_users'), (s) => {
                    const users = Object.values(s.val() || {});
                    document.getElementById('user-count').innerText = users.length;
                    const list = document.getElementById('users-list');
                    list.innerHTML = users.map(u => `<div class="user-row"><span class="status-dot"></span> ${u.name} (${u.role === 'teacher' ? 'Ù…' : 'Ø·'})</div>`).join('');
                });
            },

            render() {
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                Object.values(this.drawings).forEach(draw => {
                    if(draw.page === this.currentPage) this.drawPath(draw);
                });

                if(this.isDrawing) this.drawPath({points: this.currentPath, color: this.currentColor, thickness: this.currentThickness, mode: this.mode});
                requestAnimationFrame(() => this.render());
            },

            drawPath(draw) {
                this.ctx.beginPath();
                this.ctx.lineCap = 'round'; this.ctx.lineJoin = 'round';
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù…Ùƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ + Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØµØµØ©
                let baseW = draw.thickness || 3;
                if (draw.mode === 'marker') baseW += 7;
                if (draw.mode === 'brush') baseW += 12;
                if (draw.mode === 'eraser') baseW = 35;
                
                this.ctx.lineWidth = baseW;
                this.ctx.strokeStyle = draw.color;
                this.ctx.globalAlpha = draw.mode === 'brush' ? 0.5 : 1;
                
                if(draw.mode === 'eraser') { this.ctx.globalCompositeOperation = 'destination-out'; }
                else { this.ctx.globalCompositeOperation = 'source-over'; }
                
                if(draw.mode === 'neon') { this.ctx.shadowBlur = 15; this.ctx.shadowColor = draw.color; } else { this.ctx.shadowBlur = 0; }
                
                this.ctx.moveTo(draw.points[0].x, draw.points[0].y);
                draw.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                this.ctx.stroke();
                this.ctx.globalAlpha = 1;
            },

            adjustZoom(f, cx, cy) {
                const oldZ = this.camera.zoom;
                this.camera.zoom = Math.min(Math.max(this.camera.zoom * f, 0.1), 10);
                if(cx !== undefined) {
                    this.camera.x -= (cx - this.camera.x) * (this.camera.zoom / oldZ - 1);
                    this.camera.y -= (cy - this.camera.y) * (this.camera.zoom / oldZ - 1);
                }
                document.getElementById('zoom-info').innerText = Math.round(this.camera.zoom * 100) + "%";
            },

            resetZoom() { this.camera = {x:0, y:0, zoom:1}; document.getElementById('zoom-info').innerText = "100%"; },

            toggleSubMenu(id) {
                const el = document.getElementById(id);
                const isShow = el.classList.contains('show-menu');
                document.querySelectorAll('.sub-menu').forEach(m => m.classList.remove('show-menu'));
                if(!isShow) el.classList.add('show-menu');
            },

            setMode(m, icon) {
                this.mode = m;
                if(icon) document.getElementById('btn-pen').innerText = icon;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(m === 'move') document.getElementById('btn-move').classList.add('active');
            },

            updateColor(c) { this.currentColor = c; document.querySelectorAll('.sub-menu').forEach(m => m.classList.remove('show-menu')); },
            updateThickness(v) { this.currentThickness = parseInt(v); },

            moveToolbar(pos) {
                const bar = document.getElementById('main-toolbar');
                document.body.className = 'pos-' + pos;
                const isVertical = (pos === 'right' || pos === 'left');
                bar.classList.toggle('toolbar-vertical', isVertical);
                bar.style.top = bar.style.bottom = bar.style.left = bar.style.right = 'auto'; 
                bar.style.transform = 'none';

                if(pos === 'bottom') { bar.style.bottom = '20px'; bar.style.left = '50%'; bar.style.transform = 'translateX(-50%)'; }
                else if(pos === 'top') { bar.style.top = '20px'; bar.style.left = '50%'; bar.style.transform = 'translateX(-50%)'; }
                else if(pos === 'right') { bar.style.right = '20px'; bar.style.top = '50%'; bar.style.transform = 'translateY(-50%)'; }
                else if(pos === 'left') { bar.style.left = '20px'; bar.style.top = '50%'; bar.style.transform = 'translateY(-50%)'; }
            },

            syncChat() {
                onChildAdded(ref(db, 'chat'), (s) => {
                    const d = s.val();
                    const div = document.createElement('div');
                    div.className = `msg ${d.user === this.userName ? 'msg-me' : 'msg-them'}`;
                    div.innerHTML = `<b>${d.user}:</b> ${d.text}`;
                    document.getElementById('chat-msgs').appendChild(div);
                    document.getElementById('chat-msgs').scrollTop = 9999;
                });
            },

            sendMsg() {
                const i = document.getElementById('chat-input');
                if(!i.value.trim()) return;
                push(ref(db, 'chat'), { user: this.userName, text: i.value });
                i.value = '';
            },

            sendSystemMsg(t) { push(ref(db, 'chat'), { user: 'ğŸ“¢', text: t }); },

            toggleChat() { const p = document.getElementById('chat-panel'); p.style.display = p.style.display === 'flex' ? 'none' : 'flex'; },
            toggleUsers() { const p = document.getElementById('users-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; },
            toggleMinimize() { 
                const bar = document.getElementById('main-toolbar'); 
                const rest = document.getElementById('restore-btn');
                bar.style.display = bar.style.display === 'none' ? 'flex' : 'none'; 
                rest.style.display = bar.style.display === 'none' ? 'block' : 'none';
            },
            toggleFullscreen() {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            },
            undo() { const ks = Object.keys(this.drawings); if(ks.length) { const k = ks.pop(); this.redoStack.push(this.drawings[k]); remove(ref(db, `board_data/${k}`)); }},
            redo() { if(this.redoStack.length) push(ref(db, 'board_data'), this.redoStack.pop()); },
            clearBoard() { if(confirm("ÙƒØ±ÙŠÙ… Ø¹Ù…Ø±ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) { Object.keys(this.drawings).forEach(k => { if(this.drawings[k].page === this.currentPage) remove(ref(db, `board_data/${k}`)); })}},
            changePage(n) { this.currentPage = Math.max(1, this.currentPage + n); document.getElementById('page-label').innerText = this.currentPage; },
            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            startTimer() { let s = 0; setInterval(() => { s++; let m = Math.floor(s/60), sc = s%60; document.getElementById('timer').innerText = `${m}:${sc<10?'0':''}${sc}`; }, 1000); },
            toggleGeo(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; el.style.top = '150px'; el.style.left = '150px'; },
            makeDraggable(el) {
                let px = 0, py = 0;
                el.onpointerdown = (e) => { 
                    if(e.target.style.cursor === 'nwse-resize') return;
                    e.stopPropagation(); px = e.clientX; py = e.clientY; 
                    window.onpointermove = (ee) => { el.style.left = (el.offsetLeft + ee.clientX - px) + "px"; el.style.top = (el.offsetTop + ee.clientY - py) + "px"; px = ee.clientX; py = ee.clientY; };
                    window.onpointerup = () => { window.onpointermove = null; };
                };
            },
            makeResizable(el) {
                const resizer = el.querySelector('div[style*="nwse-resize"]');
                if(!resizer) return;
                resizer.onpointerdown = (e) => {
                    e.stopPropagation();
                    let sx = e.clientX, sy = e.clientY, sw = el.offsetWidth, sh = el.offsetHeight;
                    window.onpointermove = (ee) => { el.style.width = (sw + ee.clientX - sx) + "px"; el.style.height = (sh + ee.clientY - sy) + "px"; };
                    window.onpointerup = () => { window.onpointermove = null; };
                };
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
