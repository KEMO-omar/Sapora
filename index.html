<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket MEGA PRO | Ø§Ù„Ù…Ø³ØªØ± ÙƒØ±ÙŠÙ… Ø¹Ù…Ø±</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-glow: rgba(67, 97, 238, 0.3);
            --neon: #00f2ff;
            --secondary: #7209b7;
            --dark: #0f172a;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f1f5f9;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --trans: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Cairo', sans-serif; 
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        body { 
            background: var(--bg); 
            height: 100vh; width: 100vw; 
            overflow: hidden; touch-action: none;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© --- */
        #auth-screen {
            position: fixed; inset: 0;
            background: radial-gradient(circle at center, var(--primary), var(--dark));
            z-index: 10000; display: flex; align-items: center; justify-content: center;
        }
        .auth-card {
            background: white; padding: 40px; border-radius: 35px;
            width: 90%; max-width: 450px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            animation: bounceIn 0.8s ease;
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 0.9; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .input-group input {
            width: 100%; padding: 15px 45px 15px 15px; border: 2px solid #e2e8f0;
            border-radius: 15px; outline: none; font-size: 16px; transition: var(--trans);
            text-align: center;
        }
        .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }

        .auth-buttons { display: flex; gap: 15px; }
        .btn-auth {
            flex: 1; padding: 15px; border: none; border-radius: 15px;
            color: white; font-weight: 800; cursor: pointer; transition: var(--trans);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-teacher { background: var(--primary); }
        .btn-student { background: var(--success); }

        /* --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© --- */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            display: none; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 5000; pointer-events: none;
        }
        .nav-badge {
            background: var(--glass); padding: 10px 20px; border-radius: 20px;
            box-shadow: var(--shadow); pointer-events: auto; display: flex; align-items: center; gap: 12px;
            backdrop-filter: blur(10px); border: 1px solid white; cursor: pointer;
        }
        .badge-icon { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† --- */
        #users-sidebar {
            position: fixed; right: 20px; top: 90px; width: 260px;
            background: var(--glass); border-radius: 25px; padding: 20px;
            box-shadow: var(--shadow); display: none; z-index: 4500;
            max-height: 400px; overflow-y: auto; backdrop-filter: blur(10px);
        }
        .user-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-radius: 12px; margin-bottom: 8px; background: #f8fafc;
        }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠ (Smart Toolbar) --- */
        #toolbar-container {
            position: fixed; z-index: 6000; display: none; transition: var(--trans);
        }
        #smart-toolbar {
            background: var(--glass); padding: 12px; border-radius: 30px;
            box-shadow: var(--shadow); display: flex; backdrop-filter: blur(15px);
            border: 2px solid white; gap: 8px;
        }
        
        /* ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ÙŠØ§Øª */
        .pos-bottom { bottom: 30px; left: 50%; transform: translateX(-50%); flex-direction: row; }
        .pos-top { top: 90px; left: 50%; transform: translateX(-50%); flex-direction: row; }
        .pos-left { left: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; }
        .pos-right { right: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; }

        .tool-btn {
            width: 52px; height: 52px; border-radius: 18px; border: none;
            background: transparent; color: var(--dark); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: var(--trans); position: relative;
        }
        .tool-btn:hover { background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        .tool-btn.active { background: var(--primary); color: white; box-shadow: 0 10px 20px var(--primary-glow); }

        /* --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© (ØªÙØªØ­ Ø¹ÙƒØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡) --- */
        .pop-menu {
            position: absolute; background: white; border-radius: 25px;
            padding: 20px; box-shadow: var(--shadow); display: none;
            min-width: 220px; z-index: 7000; border: 1px solid #f1f5f9;
        }
        .active-menu { display: block !important; animation: popAnim 0.3s ease; }
        
        /* ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· */
        .anchor-top { bottom: 70px; left: 50%; transform: translateX(-50%); }
        .anchor-bottom { top: 70px; left: 50%; transform: translateX(-50%); }
        .anchor-right { left: 70px; top: 0; }
        .anchor-left { right: 70px; top: 0; }

        @keyframes popAnim { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
        .brush-opt {
            display: flex; align-items: center; gap: 15px; padding: 12px;
            border-radius: 15px; cursor: pointer; transition: 0.2s; margin-bottom: 5px;
        }
        .brush-opt:hover { background: #f8fafc; }
        .brush-name { font-weight: 800; font-size: 14px; }

        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .color-dot { width: 32px; height: 32px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-dot.active { border-color: var(--dark); transform: scale(1.1); }
        
        .shape-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .shape-opt { 
            padding: 15px; border: 2px solid #f1f5f9; border-radius: 15px; 
            text-align: center; cursor: pointer; transition: 0.2s; font-size: 20px;
        }
        .shape-opt:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Ø§Ù„Ø³Ø·Ø­ ÙˆØ§Ù„Ø±Ø³Ù… --- */
        canvas { display: block; background: #ffffff; cursor: crosshair; }

        /* --- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
        #chat-window {
            position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px;
            background: white; border-radius: 30px; box-shadow: var(--shadow);
            display: none; flex-direction: column; overflow: hidden; z-index: 5500;
        }
        .chat-header { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; }
        .msg-box { background: white; padding: 10px 15px; border-radius: 18px; font-size: 14px; max-width: 85%; align-self: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-box.mine { align-self: flex-end; background: var(--primary); color: white; }

    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color: var(--primary); font-weight: 900; font-size: 32px;">ØµØ§Ø±ÙˆØ® Ø§Ù„Ù…Ø³ØªØ± ÙƒØ±ÙŠÙ… ğŸš€</h1>
            <p style="color: #64748b; margin-bottom: 25px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2026</p>
            <div class="input-group"><i class="fas fa-user"></i><input type="text" id="userName" placeholder="Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"></div>
            <div class="input-group"><i class="fas fa-hashtag"></i><input type="text" id="roomID" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©"></div>
            <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="roomPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"></div>
            <div class="auth-buttons">
                <button class="btn-auth btn-teacher" onclick="auth('teacher')"><i class="fas fa-chalkboard-teacher"></i> Ø¯Ø®ÙˆÙ„ Ù…Ø¹Ù„Ù…</button>
                <button class="btn-auth btn-student" onclick="auth('student')"><i class="fas fa-user-graduate"></i> Ø¯Ø®ÙˆÙ„ Ø·Ø§Ù„Ø¨</button>
            </div>
        </div>
    </div>

    <div class="top-nav" id="main-nav">
        <div class="nav-badge" onclick="toggleSidebar()">
            <div class="badge-icon"><i class="fas fa-users"></i></div>
            <div>
                <div style="font-weight: 800; font-size: 14px;">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†: <span id="online-count">0</span></div>
                <div style="font-size: 10px; color: var(--success);">Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</div>
            </div>
        </div>

        <div class="nav-badge">
            <button onclick="changePage(-1)" style="border:none; background:none; cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
            <span style="font-weight: 900; min-width: 80px; text-align: center;">ØµÙØ­Ø© <span id="page-num">1</span></span>
            <button onclick="changePage(1)" style="border:none; background:none; cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
        </div>

        <div class="nav-badge" onclick="toggleFullScreen()">
            <div class="badge-icon" style="background: var(--dark);"><i class="fas fa-expand"></i></div>
            <span style="font-weight: 700;">Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</span>
        </div>
    </div>

    <div id="users-sidebar">
        <h3 style="margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ØºØ±ÙØ©</h3>
        <div id="users-list"></div>
    </div>

    <canvas id="board"></canvas>

    <div id="toolbar-container" class="pos-bottom">
        <div id="smart-toolbar">
            <button class="tool-btn" onclick="cycleToolbarPosition()" title="ØªØºÙŠÙŠØ± Ù…ÙƒØ§Ù† Ø§Ù„Ø´Ø±ÙŠØ·"><i class="fas fa-sync-alt"></i></button>
            
            <div style="position:relative;">
                <button class="tool-btn active" id="pen-btn" onclick="toggleDynamicMenu('pen-menu')"><i class="fas fa-paint-brush"></i></button>
                <div id="pen-menu" class="pop-menu">
                    <div class="brush-opt" onclick="setWriteMode('pen', 'normal')">
                        <i class="fas fa-pen" style="color: var(--primary);"></i>
                        <span class="brush-name">Ù‚Ù„Ù… Ø¹Ø§Ø¯ÙŠ</span>
                    </div>
                    <div class="brush-opt" onclick="setWriteMode('pen', 'neon')">
                        <i class="fas fa-magic" style="color: var(--neon);"></i>
                        <span class="brush-name">Ù‚Ù„Ù… Ù†ÙŠÙˆÙ†</span>
                    </div>
                    <div class="brush-opt" onclick="setWriteMode('pen', 'marker')">
                        <i class="fas fa-highlighter" style="color: #fbbf24;"></i>
                        <span class="brush-name">Ù…Ø§Ø±ÙƒØ± Ø´ÙØ§Ù</span>
                    </div>
                    <div class="brush-opt" onclick="setWriteMode('pen', 'pencil')">
                        <i class="fas fa-pencil-alt" style="color: #64748b;"></i>
                        <span class="brush-name">Ù‚Ù„Ù… Ø±ØµØ§Øµ</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
                    <div style="font-size: 12px; font-weight: 800; margin-bottom: 5px;">Ø§Ù„Ø­Ø¬Ù…: <span id="size-val">4</span>px</div>
                    <input type="range" id="size-slider" min="1" max="60" value="4" style="width:100%; accent-color: var(--primary);">
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn" id="shape-btn" onclick="toggleDynamicMenu('shape-menu')"><i class="fas fa-shapes"></i></button>
                <div id="shape-menu" class="pop-menu">
                    <div class="shape-grid">
                        <div class="shape-opt" onclick="setShape('rect')" title="Ù…Ø±Ø¨Ø¹"><i class="far fa-square"></i></div>
                        <div class="shape-opt" onclick="setShape('circle')" title="Ø¯Ø§Ø¦Ø±Ø©"><i class="far fa-circle"></i></div>
                        <div class="shape-opt" onclick="setShape('triangle')" title="Ù…Ø«Ù„Ø«"><i class="fas fa-caret-up"></i></div>
                        <div class="shape-opt" onclick="setShape('line')" title="Ø®Ø·"><i class="fas fa-minus" style="transform: rotate(-45deg);"></i></div>
                        <div class="shape-opt" onclick="setShape('arrow')" title="Ø³Ù‡Ù…"><i class="fas fa-long-arrow-alt-left"></i></div>
                        <div class="shape-opt" onclick="setShape('star')" title="Ù†Ø¬Ù…Ø©"><i class="far fa-star"></i></div>
                    </div>
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn" id="color-btn" onclick="toggleDynamicMenu('color-menu')"><i class="fas fa-palette"></i></button>
                <div id="color-menu" class="pop-menu">
                    <div class="color-grid" id="colors-container"></div>
                    <input type="color" id="custom-color" style="width:100%; height:40px; margin-top:15px; border-radius:12px; border:none; cursor:pointer;">
                </div>
            </div>

            <button class="tool-btn" id="eraser-btn" onclick="setMode('eraser')"><i class="fas fa-eraser"></i></button>
            <button class="tool-btn" id="move-btn" onclick="setMode('move')"><i class="fas fa-hand-paper"></i></button>
            <button class="tool-btn" onclick="clearFullBoard()" style="color:var(--danger);"><i class="fas fa-trash-alt"></i></button>
            <button class="tool-btn" onclick="toggleChat()"><i class="fas fa-comment-alt"></i></button>
        </div>
    </div>

    <div id="chat-window">
        <div class="chat-header"><span>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØºØ±ÙØ©</span><i class="fas fa-times" onclick="toggleChat()" style="cursor:pointer;"></i></div>
        <div id="chat-messages"></div>
        <div style="padding: 15px; display: flex; gap: 10px; background: white; border-top: 1px solid #eee;">
            <input type="text" id="chat-inp" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." style="flex:1; padding:12px; border-radius:12px; border:1px solid #ddd; outline:none;">
            <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; width:50px; border-radius:12px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ---
        let canvas = document.getElementById('board');
        let ctx = canvas.getContext('2d', { desynchronized: true });
        let isTeacher = false, isDrawing = false;
        let myName = "", roomID = "", currentPage = 1;
        let currentMode = 'pen', currentBrush = 'normal', currentShape = 'none';
        let currentColor = '#000000', currentSize = 4;
        let cam = { x: 0, y: 0 };
        let startX, startY, points = [];

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            renderAll();
        }
        window.onresize = resize;
        resize();

        // --- Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        function auth(role) {
            myName = document.getElementById('userName').value.trim();
            roomID = document.getElementById('roomID').value.trim();
            let pass = document.getElementById('roomPass').value.trim();

            if(!myName || !roomID) return alert("ÙŠØ§ Ù…Ø³ØªØ±ØŒ ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

            db.ref(`rooms/${roomID}/config`).once('value', (s) => {
                let conf = s.val();
                if(role === 'teacher') {
                    if(!conf || conf.pass === pass) {
                        if(!conf) db.ref(`rooms/${roomID}/config`).set({ pass });
                        isTeacher = true; startSystem();
                    } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£!");
                } else {
                    if(conf) { isTeacher = false; startSystem(); }
                    else alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                }
            });
        }

        function startSystem() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            document.getElementById('toolbar-container').style.display = 'block';

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
            let userRef = db.ref(`rooms/${roomID}/online/${myName}`);
            userRef.set(true);
            userRef.onDisconnect().remove();

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
            db.ref(`rooms/${roomID}/online`).on('value', (s) => {
                let users = s.val() || {};
                document.getElementById('online-count').innerText = Object.keys(users).length;
                let html = "";
                Object.keys(users).forEach(u => html += `<div class="user-item"><b>${u}</b><i class="fas fa-circle" style="color:var(--success); font-size:10px;"></i></div>`);
                document.getElementById('users-list').innerHTML = html;
            });

            initSync();
            initColors();
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø³Ù… Ø§Ù„ÙØ§Ø¦Ù‚ ---
        function initSync() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø³Ù…
            db.ref(`rooms/${roomID}/drawings/p${currentPage}`).on('child_added', (s) => drawObject(s.val()));
            db.ref(`rooms/${roomID}/drawings/p${currentPage}`).on('value', (s) => { if(!s.exists()) ctx.clearRect(0,0,canvas.width,canvas.height); });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Øª
            db.ref(`rooms/${roomID}/chat`).limitToLast(20).on('child_added', (s) => {
                let m = s.val();
                let box = document.getElementById('chat-messages');
                box.innerHTML += `<div class="msg-box ${m.user === myName ? 'mine' : ''}"><b>${m.user}</b><br>${m.text}</div>`;
                box.scrollTop = box.scrollHeight;
            });
        }

        canvas.onpointerdown = (e) => {
            if(!isTeacher && currentMode !== 'move') return;
            isDrawing = true;
            startX = e.clientX - cam.x;
            startY = e.clientY - cam.y;
            points = [{x: startX, y: startY}];
            if(currentMode === 'pen' || currentMode === 'eraser') ctx.beginPath();
        };

        window.onpointermove = (e) => {
            if(!isDrawing) return;
            let curX = e.clientX - cam.x;
            let curY = e.clientY - cam.y;

            if(currentMode === 'move') {
                cam.x += e.movementX; cam.y += e.movementY;
                renderAll(); return;
            }

            if(currentMode === 'pen' || currentMode === 'eraser') {
                points.push({x: curX, y: curY});
                ctx.save();
                applyStyle(ctx, currentMode, currentBrush, currentColor, currentSize);
                ctx.lineTo(e.clientX, e.clientY);
                ctx.stroke();
                ctx.restore();
            }
        };

        window.onpointerup = (e) => {
            if(!isDrawing || !isTeacher) { isDrawing = false; return; }
            let endX = e.clientX - cam.x;
            let endY = e.clientY - cam.y;

            if(currentMode !== 'move') {
                db.ref(`rooms/${roomID}/drawings/p${currentPage}`).push({
                    mode: currentMode, brush: currentBrush, shape: currentShape,
                    color: currentColor, size: currentSize,
                    startX, startY, endX, endY, points
                });
            }
            isDrawing = false;
            if(currentMode !== 'pen') renderAll();
        };

        function applyStyle(c, mode, brush, color, size) {
            c.strokeStyle = color;
            c.lineWidth = size;
            c.lineCap = 'round';
            c.lineJoin = 'round';
            c.globalAlpha = 1;
            c.shadowBlur = 0;
            c.globalCompositeOperation = 'source-over';

            if(mode === 'eraser') {
                c.globalCompositeOperation = 'destination-out';
                c.lineWidth = 40;
            } else {
                if(brush === 'neon') { c.shadowBlur = 15; c.shadowColor = color; }
                else if(brush === 'marker') { c.globalAlpha = 0.4; c.lineCap = 'square'; }
                else if(brush === 'pencil') { c.globalAlpha = 0.6; c.lineWidth = size/2; }
            }
        }

        function drawObject(d) {
            ctx.save();
            ctx.translate(cam.x, cam.y);
            applyStyle(ctx, d.mode, d.brush, d.color, d.size);
            ctx.beginPath();

            if(d.mode === 'pen' || d.mode === 'eraser') {
                ctx.moveTo(d.startX, d.startY);
                d.points.forEach(p => ctx.lineTo(p.x, p.y));
            } else if(d.mode === 'shape') {
                drawGeometry(d.shape, d.startX, d.startY, d.endX, d.endY);
            }
            ctx.stroke();
            ctx.restore();
        }

        function drawGeometry(type, x1, y1, x2, y2) {
            let w = x2 - x1; let h = y2 - y1;
            if(type === 'rect') ctx.strokeRect(x1, y1, w, h);
            else if(type === 'circle') {
                let r = Math.sqrt(w*w + h*h);
                ctx.arc(x1, y1, r, 0, Math.PI*2);
            } else if(type === 'line') {
                ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
            } else if(type === 'triangle') {
                ctx.moveTo(x1 + w/2, y1); ctx.lineTo(x1, y1 + h); ctx.lineTo(x1 + w, y1 + h); ctx.closePath();
            } else if(type === 'arrow') {
                let angle = Math.atan2(h, w); let head = 15;
                ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
                ctx.lineTo(x2 - head * Math.cos(angle - Math.PI/6), y2 - head * Math.sin(angle - Math.PI/6));
                ctx.moveTo(x2, y2);
                ctx.lineTo(x2 - head * Math.cos(angle + Math.PI/6), y2 - head * Math.sin(angle + Math.PI/6));
            } else if(type === 'star') {
                let rot = Math.PI / 2 * 3; let step = Math.PI / 5;
                let outer = Math.sqrt(w*w+h*h); let inner = outer/2.5;
                ctx.moveTo(x1, y1 - outer);
                for(let i=0; i<5; i++) {
                    ctx.lineTo(x1 + Math.cos(rot) * outer, y1 + Math.sin(rot) * outer); rot += step;
                    ctx.lineTo(x1 + Math.cos(rot) * inner, y1 + Math.sin(rot) * inner); rot += step;
                } ctx.closePath();
            }
        }

        function renderAll() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            db.ref(`rooms/${roomID}/drawings/p${currentPage}`).once('value', (s) => s.forEach(c => drawObject(c.val())));
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… ---
        function cycleToolbarPosition() {
            const container = document.getElementById('toolbar-container');
            const poses = ['pos-bottom', 'pos-left', 'pos-top', 'pos-right'];
            let current = poses.find(p => container.classList.contains(p));
            let next = poses[(poses.indexOf(current) + 1) % poses.length];
            container.className = next;
            
            // ØªØ­Ø¯ÙŠØ« Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ·
            document.getElementById('smart-toolbar').style.flexDirection = (next.includes('left') || next.includes('right')) ? 'column' : 'row';
            closeMenus();
        }

        function toggleDynamicMenu(id) {
            let menu = document.getElementById(id);
            let isActive = menu.classList.contains('active-menu');
            closeMenus();
            if(!isActive) {
                const pos = document.getElementById('toolbar-container').className;
                menu.className = 'pop-menu active-menu';
                // Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØªØ¬Ø§Ù‡: ØªÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ø¯Ø§Ø®Ù„
                if(pos.includes('bottom')) menu.classList.add('anchor-top');
                else if(pos.includes('top')) menu.classList.add('anchor-bottom');
                else if(pos.includes('left')) menu.classList.add('anchor-right');
                else if(pos.includes('right')) menu.classList.add('anchor-left');
            }
        }

        function closeMenus() { document.querySelectorAll('.pop-menu').forEach(m => m.classList.remove('active-menu')); }

        function setWriteMode(mode, brush) {
            currentMode = mode; currentBrush = brush; currentShape = 'none';
            updateUIBtns(); closeMenus();
        }

        function setShape(type) {
            currentMode = 'shape'; currentShape = type;
            updateUIBtns(); closeMenus();
        }

        function setMode(m) {
            currentMode = m; currentShape = 'none';
            updateUIBtns(); closeMenus();
        }

        function updateUIBtns() {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            if(currentMode === 'pen') document.getElementById('pen-btn').classList.add('active');
            else if(currentMode === 'eraser') document.getElementById('eraser-btn').classList.add('active');
            else if(currentMode === 'move') document.getElementById('move-btn').classList.add('active');
            else if(currentMode === 'shape') document.getElementById('shape-btn').classList.add('active');
        }

        function initColors() {
            const clrs = ['#000000', '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#64748b', '#00f2ff', '#ffffff'];
            let container = document.getElementById('colors-container');
            clrs.forEach(c => {
                let d = document.createElement('div');
                d.className = 'color-dot';
                d.style.backgroundColor = c;
                d.onclick = () => { currentColor = c; closeMenus(); };
                container.appendChild(d);
            });
        }

        document.getElementById('size-slider').oninput = (e) => {
            currentSize = e.target.value;
            document.getElementById('size-val').innerText = currentSize;
        };

        document.getElementById('custom-color').oninput = (e) => currentColor = e.target.value;

        // --- Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ---
        function changePage(d) {
            if(!isTeacher) return;
            db.ref(`rooms/${roomID}/drawings/p${currentPage}`).off();
            currentPage = Math.max(1, currentPage + d);
            document.getElementById('page-num').innerText = currentPage;
            renderAll(); initSync();
        }

        function clearFullBoard() {
            if(isTeacher && confirm("Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) db.ref(`rooms/${roomID}/drawings/p${currentPage}`).remove();
        }

        function toggleChat() { let c = document.getElementById('chat-window'); c.style.display = c.style.display === 'flex' ? 'none' : 'flex'; }
        function toggleSidebar() { let s = document.getElementById('users-sidebar'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
        function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

        function sendMsg() {
            let inp = document.getElementById('chat-inp');
            if(inp.value.trim()) {
                db.ref(`rooms/${roomID}/chat`).push({ user: myName, text: inp.value.trim() });
                inp.value = "";
            }
        }

        window.onclick = (e) => { if(!e.target.closest('.tool-btn') && !e.target.closest('.pop-menu')) closeMenus(); };
    </script>
</body>
</html>
