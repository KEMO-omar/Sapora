<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket V3 - Monster Elite</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --accent: #ff4757;
            --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Cairo', sans-serif;
            background: #f1f5f9; touch-action: none;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen {
            position: fixed; inset: 0; background: var(--dark);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .auth-card {
            background: white; padding: 40px; border-radius: 30px;
            width: 90%; max-width: 400px; text-align: center; box-shadow: var(--shadow);
        }

        /* Ø§Ù„Ø³Ø¨ÙˆØ±Ø© */
        #board { background: white; cursor: crosshair; display: block; }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat-panel {
            position: fixed; bottom: 100px; right: 20px;
            width: 300px; height: 400px; background: var(--glass);
            border-radius: 20px; box-shadow: var(--shadow);
            display: none; flex-direction: column; z-index: 2000;
            border: 1px solid #ddd;
        }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        .msg { margin-bottom: 8px; padding: 8px; border-radius: 10px; background: #eee; }
        .msg.me { background: var(--primary); color: white; text-align: left; }
        #chat-input-area { display: flex; padding: 10px; gap: 5px; border-top: 1px solid #eee; }

        /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
        .top-bar {
            position: fixed; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; z-index: 1000; pointer-events: none;
        }
        .badge {
            background: var(--glass); padding: 8px 15px; border-radius: 15px;
            font-size: 14px; font-weight: bold; pointer-events: auto;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.3);
            display: inline-flex; align-items: center; gap: 8px;
        }

        #main-toolbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--glass); padding: 12px; border-radius: 25px;
            box-shadow: var(--shadow); display: none; gap: 10px; align-items: center;
            z-index: 2000; border: 1px solid #fff;
        }

        .tool-btn {
            width: 45px; height: 45px; border-radius: 15px; border: none;
            background: #f1f5f9; cursor: pointer; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .tool-btn.active { background: var(--primary); color: white; }

        /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© */
        .geo-tool {
            position: absolute; background: rgba(67, 97, 238, 0.1);
            border: 2px solid var(--primary); backdrop-filter: blur(2px);
            cursor: move; display: none; z-index: 500;
        }
        .ruler { height: 50px; width: 300px; background-image: repeating-linear-gradient(90deg, #333 0, #333 2px, transparent 2px, transparent 20px); }
        .protractor { width: 200px; height: 100px; border-radius: 100px 100px 0 0; border-bottom: 3px solid #333; }

        .footer-rights { position: fixed; bottom: 5px; left: 10px; font-size: 10px; color: #64748b; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="margin-top:0">ğŸš€ MONSTER ELITE</h1>
            <p>Ù…Ù†ØµØ© Ø³Ø§Ø¨ÙˆØ±Ø© ÙƒÙŠÙ…Ùˆ Ø§Ù„Ù…Ø·ÙˆØ±Ø© V3</p>
            <input type="text" id="userName" style="width:100%; padding:15px; margin-bottom:10px; border-radius:12px; border:2px solid #eee; outline:none; box-sizing:border-box" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="rocket.login('student')" style="background:#10b981; color:white; border:none; padding:15px; border-radius:12px; cursor:pointer; font-weight:bold;">Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨</button>
                <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; cursor:pointer; font-weight:bold;">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¹Ù„Ù…</button>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div>
            <div class="badge" id="zoom-info">ğŸ” 100%</div>
            <div class="badge" id="timer">â³ 00:00</div>
        </div>
        <div>
            <div class="badge" id="user-display">ğŸ‘¤ Ø²Ø§Ø¦Ø±</div>
            <button class="badge" onclick="rocket.toggleChat()" style="cursor:pointer; border:none">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
    </div>

    <div id="chat-panel">
        <div style="padding:10px; background:var(--primary); color:white; border-radius:20px 20px 0 0; font-weight:bold">Ø´Ø§Øª Ø§Ù„Ø­ØµØ©</div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" style="flex:1; border-radius:10px; border:1px solid #ddd; padding:5px" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ...">
            <button onclick="rocket.sendChat()" style="background:var(--primary); color:white; border:none; border-radius:10px; padding:5px 10px">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <div id="tool-ruler" class="geo-tool ruler"></div>
    <div id="tool-protractor" class="geo-tool protractor"></div>

    <div id="main-toolbar">
        <div id="teacher-only-tools" style="display:none; align-items:center; gap:8px;">
            <input type="color" id="colorPicker" onchange="rocket.updateColor(this.value)" style="width:30px; height:30px; border:none; cursor:pointer">
            <button class="tool-btn active" id="btn-pen" onclick="rocket.setMode('pen')">âœï¸</button>
            <button class="tool-btn" id="btn-eraser" onclick="rocket.setMode('eraser')">ğŸ§½</button>
            <button class="tool-btn" onclick="rocket.toggleGeo('tool-ruler')">ğŸ“</button>
            <button class="tool-btn" onclick="rocket.toggleGeo('tool-protractor')">ğŸ§­</button>
            <button class="tool-btn" onclick="rocket.clearBoard()" style="color:red">ğŸ—‘ï¸</button>
            <div style="width:2px; height:30px; background:#ddd"></div>
        </div>
        <button class="tool-btn" id="btn-move" onclick="rocket.setMode('move')">ğŸ–ï¸</button>
        <div style="display:flex; align-items:center; gap:5px; background:#f1f5f9; padding:5px 10px; border-radius:15px">
            <button onclick="rocket.changePage(-1)" style="border:none; cursor:pointer">â—€</button>
            <span id="page-num">1</span>
            <button onclick="rocket.changePage(1)" style="border:none; cursor:pointer">â–¶</button>
        </div>
    </div>

    <canvas id="board"></canvas>
    <div class="footer-rights">KAREEM OMAR Â© 2026 - MONSTER ELITE V3</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹Ùƒ)
        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            isAdmin: false,
            mode: 'move',
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            camera: { x: 0, y: 0, zoom: 1 },
            drawings: {},
            currentPage: 1,
            isDrawing: false,
            currentPath: [],
            currentColor: '#000000',
            userName: '',

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.setupEvents();
                this.listenToFirebase();
                this.render();
                this.startTimer();
                this.makeDraggable(document.getElementById('tool-ruler'));
                this.makeDraggable(document.getElementById('tool-protractor'));
            },

            login(role) {
                const name = document.getElementById('userName').value.trim();
                if(!name) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¨Ø·Ù„!");
                
                if(role === 'teacher') {
                    const pass = prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø¹Ù„Ù…:");
                    if(pass !== "123") return alert("Ø®Ø·Ø£!");
                    this.isAdmin = true;
                    document.getElementById('teacher-only-tools').style.display = 'flex';
                    this.setMode('pen');
                }

                this.userName = name;
                document.getElementById('user-display').innerText = `ğŸ‘¤ ${name} (${this.isAdmin?'Ù…Ø¹Ù„Ù…':'Ø·Ø§Ù„Ø¨'})`;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-toolbar').style.display = 'flex';
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            setupEvents() {
                const getPos = (e) => ({
                    x: ( (e.clientX || e.touches[0].clientX) - this.camera.x) / this.camera.zoom,
                    y: ( (e.clientY || e.touches[0].clientY) - this.camera.y) / this.camera.zoom
                });

                const start = (e) => {
                    if(!this.isAdmin && this.mode !== 'move') return;
                    if(e.target.id !== 'board') return;
                    
                    const pos = getPos(e);
                    if(this.mode === 'move') {
                        this.isDragging = true;
                        this.lastMouse = { x: e.clientX || e.touches[0].clientX, y: e.clientY || e.touches[0].clientY };
                    } else {
                        this.isDrawing = true;
                        this.currentPath = [{x: pos.x, y: pos.y}];
                    }
                };

                const move = (e) => {
                    if(this.isDragging) {
                        const cx = e.clientX || e.touches[0].clientX;
                        const cy = e.clientY || e.touches[0].clientY;
                        this.camera.x += cx - this.lastMouse.x;
                        this.camera.y += cy - this.lastMouse.y;
                        this.lastMouse = { x: cx, y: cy };
                    } else if(this.isDrawing) {
                        const pos = getPos(e);
                        this.currentPath.push({x: pos.x, y: pos.y});
                    }
                };

                const end = () => {
                    if(this.isDrawing && this.currentPath.length > 1) {
                        push(ref(db, 'board_v3/drawings'), {
                            path: this.currentPath,
                            color: this.currentColor,
                            mode: this.mode,
                            page: this.currentPage,
                            time: Date.now()
                        });
                    }
                    this.isDrawing = this.isDragging = false;
                    this.currentPath = [];
                };

                this.canvas.addEventListener('mousedown', start);
                window.addEventListener('mousemove', move);
                window.addEventListener('mouseup', end);
                this.canvas.addEventListener('touchstart', start);
                window.addEventListener('touchmove', move);
                window.addEventListener('touchend', end);
            },

            listenToFirebase() {
                // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ù…
                onValue(ref(db, 'board_v3/drawings'), (snap) => {
                    this.drawings = snap.val() || {};
                });

                // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØµÙØ­Ø§Øª (Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒÙ„)
                onValue(ref(db, 'board_v3/config/page'), (snap) => {
                    this.currentPage = snap.val() || 1;
                    document.getElementById('page-num').innerText = this.currentPage;
                });

                // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø´Ø§Øª
                onChildAdded(ref(db, 'board_v3/chat'), (snap) => {
                    const data = snap.val();
                    const div = document.createElement('div');
                    div.className = `msg ${data.user === this.userName ? 'me' : ''}`;
                    div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
                    const container = document.getElementById('chat-messages');
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                });
            },

            render() {
                this.ctx.setTransform(1,0,0,1,0,0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†
                Object.values(this.drawings).forEach(draw => {
                    if(draw.page === this.currentPage) this.drawPath(draw);
                });

                // Ø±Ø³Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
                if(this.isDrawing) {
                    this.drawPath({ path: this.currentPath, color: this.currentColor, mode: this.mode });
                }

                requestAnimationFrame(() => this.render());
            },

            drawPath(draw) {
                if(!draw.path || draw.path.length < 2) return;
                this.ctx.beginPath();
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.lineWidth = 3;
                
                if(draw.mode === 'eraser') {
                    this.ctx.globalCompositeOperation = 'destination-out';
                    this.ctx.strokeStyle = 'rgba(0,0,0,1)';
                } else {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = draw.color;
                }

                this.ctx.moveTo(draw.path[0].x, draw.path[0].y);
                for(let i=1; i<draw.path.length; i++) {
                    this.ctx.lineTo(draw.path[i].x, draw.path[i].y);
                }
                this.ctx.stroke();
                this.ctx.globalCompositeOperation = 'source-over';
            },

            setMode(m) {
                this.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(`btn-${m}`).classList.add('active');
            },

            updateColor(c) { this.currentColor = c; this.setMode('pen'); },

            changePage(dir) {
                if(!this.isAdmin) return alert("Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙ‚Ø· ÙŠØºÙŠØ± Ø§Ù„ØµÙØ­Ø©");
                const newPage = Math.max(1, this.currentPage + dir);
                set(ref(db, 'board_v3/config/page'), newPage);
            },

            clearBoard() {
                if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) remove(ref(db, 'board_v3/drawings'));
            },

            sendChat() {
                const input = document.getElementById('chat-input');
                if(!input.value) return;
                push(ref(db, 'board_v3/chat'), {
                    user: this.userName,
                    text: input.value,
                    time: Date.now()
                });
                input.value = '';
            },

            toggleChat() {
                const p = document.getElementById('chat-panel');
                p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            },

            toggleGeo(id) {
                const el = document.getElementById(id);
                el.style.display = el.style.display === 'block' ? 'none' : 'block';
                el.style.top = '100px'; el.style.left = '100px';
            },

            makeDraggable(el) {
                let px = 0, py = 0;
                el.onmousedown = (e) => {
                    px = e.clientX; py = e.clientY;
                    const move = (ee) => {
                        el.style.left = (el.offsetLeft + (ee.clientX - px)) + "px";
                        el.style.top = (el.offsetTop + (ee.clientY - py)) + "px";
                        px = ee.clientX; py = ee.clientY;
                    };
                    const up = () => { window.removeEventListener('mousemove', move); };
                    window.addEventListener('mousemove', move);
                    window.addEventListener('mouseup', up);
                };
            },

            startTimer() {
                let s = 0;
                setInterval(() => {
                    s++;
                    let m = Math.floor(s/60), sc = s%60;
                    document.getElementById('timer').innerText = `â³ ${m}:${sc.toString().padStart(2,'0')}`;
                }, 1000);
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
