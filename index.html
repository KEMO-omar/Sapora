<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket PRO V2 | Ø§Ù„Ù…Ø³ØªØ± ÙƒØ±ÙŠÙ… Ø¹Ù…Ø±</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #7209b7;
            --neon: #00f2ff;
            --dark: #0f172a;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f1f5f9;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --trans: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Cairo', sans-serif; 
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        body { 
            background: var(--bg); 
            height: 100vh; width: 100vw; 
            overflow: hidden; touch-action: none;
        }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; inset: 0;
            background: radial-gradient(circle at center, var(--primary), var(--dark));
            z-index: 10000; display: flex; align-items: center; justify-content: center;
        }
        .auth-card {
            background: white; padding: 40px; border-radius: 35px;
            width: 90%; max-width: 450px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            animation: bounceIn 0.8s ease;
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 0.9; transform: scale(1.1); }
            80% { opacity: 1; transform: scale(0.89); }
            100% { opacity: 1; transform: scale(1); }
        }

        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .input-group input {
            width: 100%; padding: 15px 45px 15px 15px; border: 2px solid #e2e8f0;
            border-radius: 15px; outline: none; font-size: 16px; transition: var(--trans);
        }
        .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15); }

        .auth-buttons { display: flex; gap: 15px; }
        .btn-auth {
            flex: 1; padding: 15px; border: none; border-radius: 15px;
            color: white; font-weight: 800; cursor: pointer; transition: var(--trans);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-teacher { background: var(--primary); }
        .btn-student { background: var(--success); }

        /* --- UI Elements --- */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            display: none; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 5000; pointer-events: none;
        }
        .nav-badge {
            background: var(--glass); padding: 10px 20px; border-radius: 20px;
            box-shadow: var(--shadow); pointer-events: auto; display: flex; align-items: center; gap: 12px;
            backdrop-filter: blur(10px); border: 1px solid white;
        }
        .badge-icon { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* --- Users Sidebar --- */
        #users-sidebar {
            position: fixed; right: 20px; top: 90px; width: 260px;
            background: var(--glass); border-radius: 25px; padding: 20px;
            box-shadow: var(--shadow); display: none; z-index: 4500;
            max-height: 400px; overflow-y: auto; backdrop-filter: blur(10px);
        }
        .user-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-radius: 12px; margin-bottom: 8px; background: #f8fafc;
            transition: 0.2s;
        }
        .user-info { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 14px; }
        .btn-grant { padding: 5px 10px; font-size: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 800; }
        .granted { background: var(--success); color: white; }
        .not-granted { background: #e2e8f0; color: #64748b; }

        /* --- Smart Toolbar --- */
        #toolbar-container {
            position: fixed; z-index: 6000; display: none; transition: var(--trans);
        }
        #smart-toolbar {
            background: var(--glass); padding: 12px; border-radius: 30px;
            box-shadow: var(--shadow); display: flex; backdrop-filter: blur(15px);
            border: 2px solid white; gap: 8px;
        }
        
        /* Positions */
        .pos-bottom { bottom: 30px; left: 50%; transform: translateX(-50%); }
        .pos-top { top: 30px; left: 50%; transform: translateX(-50%); }
        .pos-left { left: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; }
        .pos-right { right: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; }

        .tool-btn {
            width: 52px; height: 52px; border-radius: 18px; border: none;
            background: transparent; color: var(--dark); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: var(--trans); position: relative;
        }
        .tool-btn:hover { background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        .tool-btn.active { background: var(--primary); color: white; box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3); }

        /* Pop Menus */
        .pop-menu {
            position: absolute; background: white; border-radius: 25px;
            padding: 20px; box-shadow: var(--shadow); display: none;
            min-width: 220px; z-index: 7000; border: 1px solid #f1f5f9;
        }
        .active-menu { display: block !important; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Canvas --- */
        canvas { display: block; background: #ffffff; cursor: crosshair; }

        /* --- Extra Controls --- */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .color-dot { width: 32px; height: 32px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: var(--dark); transform: scale(1.1); }
        #custom-color-btn { width: 100%; height: 40px; border-radius: 10px; border: 2px dashed #ccc; margin-top: 10px; cursor: pointer; }

        /* --- Chat Window --- */
        #chat-window {
            position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px;
            background: white; border-radius: 30px; box-shadow: var(--shadow);
            display: none; flex-direction: column; overflow: hidden; z-index: 5500;
            border: 1px solid #eee;
        }
        .chat-header { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; }
        .msg-box { position: relative; background: white; padding: 10px 15px; border-radius: 18px; font-size: 14px; max-width: 85%; align-self: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-box.mine { align-self: flex-end; background: var(--primary); color: white; }
        .delete-msg { position: absolute; left: -25px; top: 50%; transform: translateY(-50%); color: var(--danger); cursor: pointer; font-size: 12px; display: none; }
        .is-teacher .delete-msg { display: block; }
        
        /* Toolbar Toggle Button */
        #toggle-toolbar-visibility {
            position: fixed; bottom: 20px; left: 20px; width: 40px; height: 40px;
            background: var(--dark); color: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 9000;
        }

    </style>
</head>
<body class="">

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color: var(--primary); font-weight: 900; font-size: 32px; margin-bottom: 10px;">ØµØ§Ø±ÙˆØ® Ø§Ù„Ù…Ø³ØªØ± 2026 ğŸš€</h1>
            <p style="color: #64748b; margin-bottom: 30px;">Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ Ø§Ù„Ø£Ø°ÙƒÙ‰ ÙÙŠ Ù…ØµØ±</p>
            
            <div class="input-group">
                <i class="fas fa-user-tie"></i>
                <input type="text" id="userName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>
            <div class="input-group">
                <i class="fas fa-hashtag"></i>
                <input type="text" id="roomID" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="roomPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>

            <div class="auth-buttons">
                <button class="btn-auth btn-teacher" onclick="auth('teacher')">Ø¯Ø®ÙˆÙ„ (Ù…Ø¹Ù„Ù…)</button>
                <button class="btn-auth btn-student" onclick="auth('student')">Ø¯Ø®ÙˆÙ„ (Ø·Ø§Ù„Ø¨)</button>
            </div>
        </div>
    </div>

    <div id="toggle-toolbar-visibility" onclick="toggleToolbarUI()"><i class="fas fa-eye"></i></div>

    <div class="top-nav" id="main-nav">
        <div class="nav-badge" onclick="toggleSidebar()">
            <div class="badge-icon"><i class="fas fa-users"></i></div>
            <div>
                <div style="font-weight: 800; font-size: 14px;">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†: <span id="count">0</span></div>
                <div style="font-size: 10px; color: var(--success);">ØºØ±ÙØ© Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†</div>
            </div>
        </div>

        <div class="nav-badge">
            <button onclick="movePage(-1)" style="border:none; background:none; cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
            <span style="font-weight: 900; min-width: 80px; text-align: center;">ØµÙØ­Ø© <span id="p-num">1</span></span>
            <button onclick="movePage(1)" style="border:none; background:none; cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
        </div>

        <div class="nav-badge" onclick="toggleFullScreen()" style="cursor: pointer;">
            <div class="badge-icon" style="background: var(--dark);"><i class="fas fa-expand"></i></div>
            <span style="font-weight: 700;">ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø©</span>
        </div>
    </div>

    <div id="users-sidebar">
        <h3 style="margin-bottom: 15px; font-size: 16px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
        <div id="users-list"></div>
    </div>

    <canvas id="board"></canvas>

    <div id="toolbar-container" class="pos-bottom">
        <div id="smart-toolbar">
            <button class="tool-btn" onclick="cyclePosition()"><i class="fas fa-arrows-alt"></i></button>
            
            <div style="position:relative;">
                <button class="tool-btn active" id="pen-btn" onclick="openMenu('pen-menu')"><i class="fas fa-pen-nib"></i></button>
                <div id="pen-menu" class="pop-menu">
                    <div onclick="setMode('pen', 'normal')" class="tool-btn" style="width:100%; justify-content: flex-start; gap:10px;">
                        <i class="fas fa-pen"></i> <span>Ù‚Ù„Ù… Ø¹Ø§Ø¯ÙŠ</span>
                    </div>
                    <div onclick="setMode('pen', 'neon')" class="tool-btn" style="width:100%; justify-content: flex-start; gap:10px;">
                        <i class="fas fa-magic"></i> <span>Ù‚Ù„Ù… Ù†ÙŠÙˆÙ†</span>
                    </div>
                    <hr>
                    <p style="font-size: 12px; margin: 10px 0;">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</p>
                    <input type="range" id="pen-size" min="1" max="50" value="4" style="width:100%;">
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn" id="color-btn" onclick="openMenu('color-menu')"><i class="fas fa-palette"></i></button>
                <div id="color-menu" class="pop-menu">
                    <div class="color-grid" id="colors-container"></div>
                    <input type="color" id="custom-color-picker" onchange="setCustomColor(this.value)">
                </div>
            </div>

            <button class="tool-btn" id="eraser-btn" onclick="setMode('eraser')"><i class="fas fa-eraser"></i></button>
            <button class="tool-btn" id="move-btn" onclick="setMode('move')"><i class="fas fa-hand-rock"></i></button>
            <button class="tool-btn" onclick="clearCanvas()" style="color:var(--danger);"><i class="fas fa-trash"></i></button>
            <button class="tool-btn" onclick="toggleChat()"><i class="fas fa-comments"></i></button>
        </div>
    </div>

    <div id="chat-window">
        <div class="chat-header">
            <span>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø³ØªØ±</span>
            <i class="fas fa-times" onclick="toggleChat()" style="cursor:pointer;"></i>
        </div>
        <div id="chat-messages"></div>
        <div style="padding: 15px; display: flex; gap: 10px; border-top: 1px solid #eee;">
            <input type="text" id="chat-inp" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." style="flex:1; padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
            <button onclick="sendMsg()" style="background: var(--primary); color:white; border:none; padding: 10px 20px; border-radius: 10px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const config = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        // --- Core Variables ---
        let canvas = document.getElementById('board');
        let ctx = canvas.getContext('2d', { desynchronized: true });
        let isTeacher = false;
        let canDraw = false;
        let myName = "";
        let roomID = "";
        let page = 1;
        let mode = 'pen';
        let brush = 'normal';
        let color = '#000000';
        let size = 4;
        let isDrawing = false;
        let cam = { x: 0, y: 0 };
        let points = [];

        // --- App Setup ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redraw();
        }
        window.onresize = resize;
        resize();

        // --- Auth System ---
        function auth(role) {
            myName = document.getElementById('userName').value.trim();
            roomID = document.getElementById('roomID').value.trim();
            let pass = document.getElementById('roomPass').value;

            if(!myName || !roomID) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            db.ref(`rooms/${roomID}/config`).once('value', (s) => {
                let data = s.val();
                if(role === 'teacher') {
                    if(!data || data.pass === pass) {
                        if(!data) db.ref(`rooms/${roomID}/config`).set({ pass: pass });
                        isTeacher = true;
                        canDraw = true;
                        startApp();
                    } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£");
                } else {
                    if(data) {
                        isTeacher = false;
                        startApp();
                    } else alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
                }
            });
        }

        function startApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            document.getElementById('toolbar-container').style.display = 'block';
            document.getElementById('toggle-toolbar-visibility').style.display = 'flex';
            if(isTeacher) document.body.classList.add('is-teacher');

            // Presence
            let ref = db.ref(`rooms/${roomID}/users/${myName}`);
            ref.set({ role: isTeacher ? 'teacher' : 'student', canDraw: isTeacher });
            ref.onDisconnect().remove();

            // Sync Users
            db.ref(`rooms/${roomID}/users`).on('value', (s) => {
                let users = s.val() || {};
                document.getElementById('count').innerText = Object.keys(users).length;
                let html = "";
                Object.keys(users).forEach(u => {
                    let isG = users[u].canDraw;
                    if(u === myName && !isTeacher) canDraw = isG;
                    html += `
                        <div class="user-item">
                            <div class="user-info">
                                <div style="width:8px; height:8px; border-radius:50%; background:var(--success)"></div>
                                ${u}
                            </div>
                            ${isTeacher && u !== myName ? 
                                `<button class="btn-grant ${isG?'granted':'not-granted'}" onclick="toggleGrant('${u}', ${isG})">
                                    ${isG ? 'Ø³Ø­Ø¨ Ø§Ù„Ø¥Ø°Ù†' : 'Ø¥Ø°Ù† ÙƒØªØ§Ø¨Ø©'}
                                </button>` : ''}
                        </div>
                    `;
                });
                document.getElementById('users-list').innerHTML = html;
            });

            initDrawSync();
            initChatSync();
            initColors();
        }

        // --- Interaction Logic ---
        function toggleGrant(user, current) {
            db.ref(`rooms/${roomID}/users/${user}/canDraw`).set(!current);
        }

        function initDrawSync() {
            // Listen for new drawings
            db.ref(`rooms/${roomID}/draws/p${page}`).on('child_added', (s) => {
                drawObj(s.val());
            });

            // Listen for clear
            db.ref(`rooms/${roomID}/draws/p${page}`).on('value', (s) => {
                if(!s.exists()) {
                    ctx.clearRect(0,0,canvas.width, canvas.height);
                }
            });
        }

        canvas.onpointerdown = (e) => {
            if(!canDraw && mode !== 'move') return;
            isDrawing = true;
            let x = e.clientX - cam.x;
            let y = e.clientY - cam.y;
            points = [{x, y}];
            if(mode === 'pen' || mode === 'eraser') {
                ctx.beginPath();
                ctx.moveTo(e.clientX, e.clientY);
            }
        };

        window.onpointermove = (e) => {
            if(!isDrawing) return;
            let x = e.clientX - cam.x;
            let y = e.clientY - cam.y;

            if(mode === 'move') {
                cam.x += e.movementX;
                cam.y += e.movementY;
                redraw();
                return;
            }

            points.push({x, y});
            
            // Local Preview
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if(mode === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 30;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = color;
                if(brush === 'neon') { ctx.shadowBlur = 10; ctx.shadowColor = color; }
                else { ctx.shadowBlur = 0; }
            }
            ctx.lineTo(e.clientX, e.clientY);
            ctx.stroke();
        };

        window.onpointerup = () => {
            if(!isDrawing) return;
            isDrawing = false;
            if(mode !== 'move' && canDraw) {
                db.ref(`rooms/${roomID}/draws/p${page}`).push({
                    mode, brush, color, size, points,
                    user: myName
                });
            }
            if(!isTeacher) redraw(); // Prevent local mess for students
        };

        function drawObj(d) {
            ctx.save();
            ctx.translate(cam.x, cam.y);
            ctx.beginPath();
            ctx.lineWidth = d.size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if(d.mode === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 40;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = d.color;
                if(d.brush === 'neon') { ctx.shadowBlur = 15; ctx.shadowColor = d.color; }
            }

            if(d.points && d.points.length > 0) {
                ctx.moveTo(d.points[0].x, d.points[0].y);
                d.points.forEach(p => ctx.lineTo(p.x, p.y));
            }
            ctx.stroke();
            ctx.restore();
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            db.ref(`rooms/${roomID}/draws/p${page}`).once('value', (s) => {
                s.forEach(child => drawObj(child.val()));
            });
        }

        // --- Tools UI ---
        function setMode(m, b = 'normal') {
            mode = m; brush = b;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            if(m === 'pen') document.getElementById('pen-btn').classList.add('active');
            if(m === 'eraser') document.getElementById('eraser-btn').classList.add('active');
            if(m === 'move') document.getElementById('move-btn').classList.add('active');
            closeMenus();
        }

        function initColors() {
            const colors = ['#000000', '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#64748b', '#00f2ff', '#ffffff'];
            let html = "";
            colors.forEach(c => {
                html += `<div class="color-dot" style="background:${c}" onclick="setColor('${c}')"></div>`;
            });
            document.getElementById('colors-container').innerHTML = html;
        }

        function setColor(c) {
            color = c;
            document.getElementById('color-btn').style.color = c;
            closeMenus();
        }

        function setCustomColor(c) {
            color = c;
            document.getElementById('color-btn').style.color = c;
        }

        function openMenu(id) {
            let m = document.getElementById(id);
            let isOpen = m.classList.contains('active-menu');
            closeMenus();
            if(!isOpen) m.classList.add('active-menu');
        }

        function closeMenus() {
            document.querySelectorAll('.pop-menu').forEach(m => m.classList.remove('active-menu'));
        }

        function cyclePosition() {
            const container = document.getElementById('toolbar-container');
            const poses = ['pos-bottom', 'pos-left', 'pos-top', 'pos-right'];
            let current = poses.find(p => container.classList.contains(p));
            let next = poses[(poses.indexOf(current) + 1) % poses.length];
            container.classList.remove(current);
            container.classList.add(next);
            if(next.includes('left') || next.includes('right')) {
                document.getElementById('smart-toolbar').style.flexDirection = 'column';
            } else {
                document.getElementById('smart-toolbar').style.flexDirection = 'row';
            }
        }

        // --- Navigation ---
        function movePage(dir) {
            // Student moves page locally, Teacher moves for everyone?
            // Requirement: Student can move for himself.
            page = Math.max(1, page + dir);
            document.getElementById('p-num').innerText = page;
            db.ref(`rooms/${roomID}/draws/p${page}`).off();
            initDrawSync();
            redraw();
        }

        function clearCanvas() {
            if(!canDraw) return;
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
                db.ref(`rooms/${roomID}/draws/p${page}`).remove();
            }
        }

        // --- Chat System ---
        function initChatSync() {
            db.ref(`rooms/${roomID}/chat`).on('child_added', (s) => {
                let m = s.val();
                let isMine = m.user === myName;
                let html = `
                    <div class="msg-box ${isMine?'mine':''}" id="msg-${s.key}">
                        <b style="font-size:10px; display:block;">${m.user}</b>
                        ${m.text}
                        <i class="fas fa-trash delete-msg" onclick="deleteMsg('${s.key}')"></i>
                    </div>
                `;
                document.getElementById('chat-messages').innerHTML += html;
                document.getElementById('chat-messages').scrollTop = 99999;
            });

            db.ref(`rooms/${roomID}/chat`).on('child_removed', (s) => {
                document.getElementById(`msg-${s.key}`)?.remove();
            });
        }

        function sendMsg() {
            let inp = document.getElementById('chat-inp');
            if(!inp.value.trim()) return;
            db.ref(`rooms/${roomID}/chat`).push({
                user: myName,
                text: inp.value.trim()
            });
            inp.value = "";
        }

        function deleteMsg(key) {
            if(isTeacher) db.ref(`rooms/${roomID}/chat/${key}`).remove();
        }

        // --- UI Utilities ---
        function toggleSidebar() {
            let s = document.getElementById('users-sidebar');
            s.style.display = s.style.display === 'block' ? 'none' : 'block';
        }

        function toggleChat() {
            let c = document.getElementById('chat-window');
            c.style.display = c.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleToolbarUI() {
            let t = document.getElementById('toolbar-container');
            t.style.display = t.style.display === 'none' ? 'block' : 'none';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        // --- Initialization ---
        document.getElementById('pen-size').oninput = (e) => size = e.target.value;
        document.getElementById('chat-inp').onkeydown = (e) => { if(e.key === 'Enter') sendMsg(); };

    </script>
</body>
</html>
