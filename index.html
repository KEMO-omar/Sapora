<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket Turbo V3 - MONSTER ELITE</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.98); --shadow: 0 20px 50px rgba(0,0,0,0.15); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: #f8fafc; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card { background: white; padding: 40px; border-radius: 30px; box-shadow: var(--shadow); width: 90%; max-width: 420px; text-align: center; }
        .input-name { width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 15px; border: 2px solid #e2e8f0; font-size: 18px; text-align: center; outline: none; transition: 0.3s; }
        .input-name:focus { border-color: var(--primary); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-bar { position: fixed; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge-group { display: flex; gap: 10px; pointer-events: auto; }
        .badge { background: var(--glass); padding: 8px 18px; border-radius: 20px; box-shadow: var(--shadow); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(0,0,0,0.05); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - ØªØµÙ…ÙŠÙ… Ø¹Ø§Ø¦Ù… */
        #main-toolbar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: var(--glass); backdrop-filter: blur(20px); padding: 12px 25px; 
            border-radius: 100px; box-shadow: var(--shadow); display: none; gap: 12px; 
            align-items: center; z-index: 2000; border: 1px solid rgba(255,255,255,0.2);
        }

        .tool-btn { 
            width: 50px; height: 50px; border-radius: 50%; border: none; 
            background: transparent; cursor: pointer; font-size: 22px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; align-items: center; justify-content: center; position: relative; color: #475569;
        }
        .tool-btn:hover { background: #f1f5f9; transform: scale(1.15); color: var(--primary); }
        .tool-btn.active { background: var(--primary); color: white !important; box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3); }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .popup-menu {
            position: absolute; bottom: 80px; background: white; padding: 15px; 
            border-radius: 25px; box-shadow: var(--shadow); display: none; 
            grid-template-columns: repeat(3, 1fr); gap: 12px; min-width: 180px; border: 1px solid #f1f5f9;
        }
        .show-popup { display: grid !important; animation: popUp 0.3s ease-out; }
        @keyframes popUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª */
        #page-manager { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 5px 15px; border-radius: 30px; margin: 0 10px; }

        /* Ù…Ù†Ù‚ÙŠ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ */
        #colorPreview { 
            width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; 
            cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.1); transition: 0.3s;
        }
        #colorPicker { display: none; }

        /* Ø§Ù„Ù‚Ù…Ø§Ø´ */
        #board { background: #ffffff; touch-action: none; cursor: crosshair; }

        /* Ø²Ø± Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
        .fs-btn { position: fixed; bottom: 35px; right: 30px; z-index: 2000; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card">
            <h1 style="color:var(--dark); margin-bottom:10px;">ğŸš€ MONSTER ELITE</h1>
            <p style="color:#64748b; margin-bottom:30px;">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø¨Ø¯Ø¹ÙŠÙ†</p>
            <input type="text" id="userName" class="input-name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button onclick="rocket.login('student')" style="background:#10b981; color:white; padding:18px; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:16px;">Ø·Ø§Ù„Ø¨</button>
                <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; padding:18px; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:16px;">Ù…Ø¹Ù„Ù…</button>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div class="badge-group">
            <div class="badge" id="zoom-info">ğŸ” 100%</div>
            <div class="badge" id="status-online">ğŸŸ¢ 0 Ù…ØªØµÙ„</div>
            <div class="badge">ğŸ“… <span id="live-date"></span></div>
        </div>
        <div class="badge-group">
            <div class="badge" id="timer">â³ 00:00</div>
            <div class="badge" id="user-tag">ğŸ‘¤ Ø²Ø§Ø¦Ø±</div>
        </div>
    </div>

    <div id="main-toolbar">
        <div style="position:relative">
            <div id="colorPreview" onclick="document.getElementById('colorPicker').click()"></div>
            <input type="color" id="colorPicker" onchange="rocket.updateColor(this.value)">
        </div>

        <div style="position:relative">
            <button class="tool-btn active" id="btn-brush" onclick="rocket.togglePopup('brush-menu')" title="Ø§Ù„ÙØ±Ø´">ğŸ–Œï¸</button>
            <div id="brush-menu" class="popup-menu">
                <button class="tool-btn" onclick="rocket.setMode('pen', 'âœï¸')">âœï¸</button>
                <button class="tool-btn" onclick="rocket.setMode('calligraphy', 'ğŸ–‹ï¸')">ğŸ–‹ï¸</button>
                <button class="tool-btn" onclick="rocket.setMode('neon', 'ğŸŒŸ')">ğŸŒŸ</button>
                <button class="tool-btn" onclick="rocket.setMode('highlighter', 'ğŸ–ï¸')">ğŸ–ï¸</button>
                <button class="tool-btn" onclick="rocket.setMode('oil', 'ğŸ¨')">ğŸ¨</button>
            </div>
        </div>

        <div style="position:relative">
            <button class="tool-btn" onclick="rocket.togglePopup('shape-menu')" title="Ø£Ø´ÙƒØ§Ù„">ğŸ“</button>
            <div id="shape-menu" class="popup-menu">
                <button class="tool-btn" onclick="rocket.setMode('rect', 'â¬œ')">â¬œ</button>
                <button class="tool-btn" onclick="rocket.setMode('circle', 'â­•')">â­•</button>
                <button class="tool-btn" onclick="rocket.setMode('line', 'ğŸ“')">ğŸ“</button>
            </div>
        </div>

        <button class="tool-btn" onclick="rocket.setMode('eraser', 'ğŸ§½')" title="Ù…Ù…Ø­Ø§Ø©">ğŸ§½</button>
        <button class="tool-btn" onclick="rocket.setMode('move', 'ğŸ–ï¸')" title="ØªØ­Ø±ÙŠÙƒ">ğŸ–ï¸</button>
        
        <div id="page-manager">
            <button class="tool-btn" style="width:30px; height:30px; font-size:14px" onclick="rocket.prevPage()">â—€</button>
            <span id="page-num" style="font-weight:bold; min-width:60px; text-align:center">ØµÙØ­Ø© 1</span>
            <button class="tool-btn" style="width:30px; height:30px; font-size:14px" onclick="rocket.nextPage()">â–¶</button>
        </div>

        <input type="range" id="sizePicker" style="width:80px; accent-color:var(--primary);" min="1" max="80" value="5">

        <button class="tool-btn" onclick="rocket.undo()" title="ØªØ±Ø§Ø¬Ø¹">â†©ï¸</button>
        <button class="tool-btn" onclick="rocket.download()" title="ØªØ­Ù…ÙŠÙ„ ÙƒØµÙˆØ±Ø©">ğŸ“¸</button>
        <button class="tool-btn" onclick="rocket.clearBoard()" style="color:var(--accent)" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„">ğŸ—‘ï¸</button>
    </div>

    <button class="tool-btn fs-btn" style="background:white; box-shadow:var(--shadow)" onclick="rocket.toggleFS()">ğŸ“º</button>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, query, limitToLast, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            isAdmin: false,
            mode: 'pen',
            isDrawing: false,
            drawings: {},
            camera: { x: 0, y: 0, zoom: 1 },
            userName: "Ø²Ø§Ø¦Ø±",
            currentColor: '#4361ee',
            currentPage: 1,
            currentPath: [],

            init() {
                this.resize();
                window.onresize = () => this.resize();
                document.getElementById('colorPreview').style.background = this.currentColor;
                document.getElementById('live-date').innerText = new Date().toLocaleDateString('ar-EG');
                this.setupEvents();
                this.syncData();
                this.render();
                this.startTimer();
            },

            login(role) {
                const name = document.getElementById('userName').value.trim();
                if(!name) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
                if(role === 'teacher' && prompt("Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…:") !== "123") return;
                
                this.isAdmin = (role === 'teacher');
                this.userName = name;
                document.getElementById('auth-screen').style.transform = 'scale(1.2)';
                document.getElementById('auth-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('main-toolbar').style.display = 'flex';
                }, 600);
                
                document.getElementById('user-tag').innerText = `ğŸ‘¤ ${name}`;
                set(ref(db, `presence/${name}`), { active: true, role });
                onDisconnect(ref(db, `presence/${name}`)).remove();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            setupEvents() {
                this.canvas.addEventListener('pointerdown', e => this.onStart(e));
                this.canvas.addEventListener('pointermove', e => this.onMove(e));
                this.canvas.addEventListener('pointerup', () => this.onEnd());
                window.addEventListener('wheel', e => this.onZoom(e), { passive: false });
                
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('.tool-btn') && !e.target.closest('.popup-menu')) {
                        document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show-popup'));
                    }
                });
            },

            togglePopup(id) {
                const menu = document.getElementById(id);
                const isOpen = menu.classList.contains('show-popup');
                document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show-popup'));
                if(!isOpen) menu.classList.add('show-popup');
            },

            updateColor(val) {
                this.currentColor = val;
                document.getElementById('colorPreview').style.background = val;
            },

            setMode(m, icon) {
                this.mode = m;
                document.getElementById('btn-brush').innerText = icon;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(m !== 'move' && m !== 'eraser') document.getElementById('btn-brush').classList.add('active');
                document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show-popup'));
            },

            getPos(e) {
                return {
                    x: (e.clientX - this.camera.x) / this.camera.zoom,
                    y: (e.clientY - this.camera.y) / this.camera.zoom
                };
            },

            onStart(e) {
                if(!this.isAdmin && this.mode !== 'move') return;
                this.isDrawing = true;
                const pos = this.getPos(e);
                this.startX = pos.x;
                this.startY = pos.y;
                this.currentPath = [{x: pos.x, y: pos.y}];
            },

            onMove(e) {
                if(!this.isDrawing) return;
                const pos = this.getPos(e);
                if(this.mode === 'move') {
                    this.camera.x += e.movementX;
                    this.camera.y += e.movementY;
                } else {
                    this.currentPath.push({x: pos.x, y: pos.y});
                    this.tempEnd = pos;
                }
            },

            onEnd() {
                if(!this.isDrawing) return;
                this.isDrawing = false;
                if(this.mode !== 'move') {
                    const data = {
                        type: this.mode, color: this.currentColor,
                        size: document.getElementById('sizePicker').value,
                        points: this.currentPath, startX: this.startX, startY: this.startY,
                        endX: this.tempEnd?.x, endY: this.tempEnd?.y,
                        page: this.currentPage
                    };
                    push(ref(db, 'board_data'), data);
                }
            },

            onZoom(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.95 : 1.05;
                this.camera.zoom *= delta;
                document.getElementById('zoom-info').innerText = `ğŸ” ${Math.round(this.camera.zoom*100)}%`;
            },

            syncData() {
                onValue(ref(db, 'board_data'), s => { this.drawings = s.val() || {}; });
                onValue(ref(db, 'presence'), s => {
                    document.getElementById('status-online').innerText = `ğŸŸ¢ ${s.size || 0} Ù…ØªØµÙ„`;
                });
            },

            drawItem(it) {
                if(it.page !== this.currentPage) return;
                this.ctx.beginPath();
                this.ctx.strokeStyle = it.color;
                this.ctx.lineWidth = it.size;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                if(['pen', 'neon', 'highlighter', 'calligraphy', 'oil', 'eraser'].includes(it.type)) {
                    if(it.type === 'eraser') this.ctx.strokeStyle = '#ffffff';
                    if(it.type === 'neon') { this.ctx.shadowBlur = 20; this.ctx.shadowColor = it.color; }
                    if(it.type === 'highlighter') this.ctx.globalAlpha = 0.3;
                    if(it.type === 'calligraphy') this.ctx.lineWidth = it.size * 2.5;
                    
                    this.ctx.moveTo(it.points[0].x, it.points[0].y);
                    it.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1; this.ctx.shadowBlur = 0;
                } else if(it.type === 'rect') {
                    this.ctx.strokeRect(it.startX, it.startY, it.endX - it.startX, it.endY - it.startY);
                } else if(it.type === 'circle') {
                    let r = Math.hypot(it.endX - it.startX, it.endY - it.startY);
                    this.ctx.arc(it.startX, it.startY, r, 0, Math.PI*2);
                    this.ctx.stroke();
                } else if(it.type === 'line') {
                    this.ctx.moveTo(it.startX, it.startY);
                    this.ctx.lineTo(it.endX, it.endY);
                    this.ctx.stroke();
                }
            },

            render() {
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                Object.values(this.drawings).forEach(it => this.drawItem(it));

                if(this.isDrawing && this.mode !== 'move') {
                    this.drawItem({
                        type: this.mode, color: this.currentColor,
                        size: document.getElementById('sizePicker').value,
                        points: this.currentPath, startX: this.startX, startY: this.startY,
                        endX: this.tempEnd?.x, endY: this.tempEnd?.y,
                        page: this.currentPage
                    });
                }
                requestAnimationFrame(() => this.render());
            },

            nextPage() { this.currentPage++; document.getElementById('page-num').innerText = `ØµÙØ­Ø© ${this.currentPage}`; },
            prevPage() { if(this.currentPage > 1) { this.currentPage--; document.getElementById('page-num').innerText = `ØµÙØ­Ø© ${this.currentPage}`; } },

            undo() {
                const q = query(ref(db, 'board_data'), limitToLast(1));
                get(q).then(s => { if(s.exists()) remove(ref(db, `board_data/${Object.keys(s.val())[0]}`)); });
            },

            clearBoard() { if(this.isAdmin && confirm("Ø­Ø°Ù Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) {
                Object.keys(this.drawings).forEach(key => {
                    if(this.drawings[key].page === this.currentPage) remove(ref(db, `board_data/${key}`));
                });
            }},

            download() {
                const link = document.createElement('a');
                link.download = `sapora-page-${this.currentPage}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
            },

            toggleFS() {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            },

            startTimer() {
                let sec = 0;
                setInterval(() => {
                    sec++;
                    let m = Math.floor(sec/60), s = sec%60;
                    document.getElementById('timer').innerText = `â³ ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }, 1000);
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
