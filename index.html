<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket Turbo V3 - MONSTER ELITE</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.95); --shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: #f1f5f9; }
        
        #auth-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; }
        
        /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© */
        .top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge { background: var(--glass); padding: 5px 15px; border-radius: 15px; font-size: 13px; font-weight: bold; pointer-events: auto; box-shadow: var(--shadow); border: 1px solid #eee; margin-bottom: 5px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± */
        #main-toolbar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: var(--glass); padding: 10px; border-radius: 20px; 
            box-shadow: var(--shadow); display: none; gap: 8px; align-items: center; z-index: 2000;
            transition: all 0.3s ease; border: 1px solid #ddd;
        }
        .toolbar-minimized { width: 50px !important; height: 50px !important; overflow: hidden; border-radius: 50% !important; }

        .tool-btn { 
            width: 42px; height: 42px; border-radius: 12px; border: none; 
            background: #f8fafc; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn.active { background: var(--primary); color: white; }
        
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }

        /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© */
        .geo-tool {
            position: absolute; background: rgba(200, 230, 255, 0.4); border: 1px solid var(--primary);
            backdrop-filter: blur(2px); cursor: move; display: none; z-index: 500;
        }
        .ruler { height: 50px; width: 300px; background-image: linear-gradient(90deg, #333 1px, transparent 1px); background-size: 10px 20px; background-repeat: repeat-x; background-position: bottom; }
        .resizer { position: absolute; right: 0; top: 0; bottom: 0; width: 10px; cursor: ew-resize; background: var(--primary); opacity: 0.5; }

        #board { background: white; touch-action: none; }
        
        .footer-rights { position: fixed; bottom: 5px; left: 10px; font-size: 10px; color: #94a3b8; z-index: 50; }
        .personal-link { position: fixed; bottom: 5px; right: 10px; z-index: 50; text-decoration: none; font-size: 12px; background: white; padding: 2px 8px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card">
            <h2 style="margin-top:0">ğŸš€ MONSTER ELITE</h2>
            <input type="text" id="userName" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;" placeholder="Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="rocket.login('student')" style="background:#10b981; color:white; padding:12px; border:none; border-radius:10px; cursor:pointer;">Ø·Ø§Ù„Ø¨</button>
                <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; padding:12px; border:none; border-radius:10px; cursor:pointer;">Ù…Ø¹Ù„Ù…</button>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div>
            <div class="badge" id="zoom-info">ğŸ” 100%</div>
            <div class="badge" id="sync-status" onclick="rocket.toggleSync()" style="cursor:pointer; background:#dcfce7">ğŸ”„ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø³ØªØ±</div>
        </div>
        <div>
            <div class="badge" id="timer">â³ 00:00</div>
            <div class="badge" id="user-tag">ğŸ‘¤ Ø²Ø§Ø¦Ø±</div>
        </div>
    </div>

    <div id="ruler" class="geo-tool ruler"><div class="resizer" onmousedown="rocket.startResize(event, 'ruler')"></div></div>
    <div id="protractor" class="geo-tool" style="width:200px; height:100px; border-radius:100px 100px 0 0; border-bottom: 2px solid var(--primary);"></div>

    <div id="main-toolbar">
        <button class="tool-btn" onclick="rocket.toggleMinimize()" title="ØªØµØºÙŠØ±">ğŸ“¦</button>
        
        <div id="teacher-controls" style="display:none; flex-direction:row; align-items:center; gap:8px;">
            <div class="color-dot" style="background:#000000" onclick="rocket.updateColor('#000000')"></div>
            <div class="color-dot" style="background:#ff4757" onclick="rocket.updateColor('#ff4757')"></div>
            <div class="color-dot" style="background:#2ed573" onclick="rocket.updateColor('#2ed573')"></div>
            <div class="color-dot" style="background:#4361ee" onclick="rocket.updateColor('#4361ee')"></div>
            <input type="color" id="colorPicker" onchange="rocket.updateColor(this.value)" style="width:30px; height:30px; border:none; cursor:pointer;">
            
            <button class="tool-btn" onclick="rocket.setMode('pen')" id="pen-btn">âœï¸</button>
            <button class="tool-btn" onclick="rocket.toggleGeo('ruler')">ğŸ“</button>
            <button class="tool-btn" onclick="rocket.setMode('eraser')">ğŸ§½</button>
            <button class="tool-btn" onclick="rocket.undo()">â†©ï¸</button>
            <button class="tool-btn" onclick="rocket.redo()">â†ªï¸</button>
            <button class="tool-btn" onclick="rocket.clearBoard()" style="color:red">ğŸ—‘ï¸</button>
            
            <select onchange="rocket.moveToolbar(this.value)" style="padding:5px; border-radius:5px;">
                <option value="bottom">Ø£Ø³ÙÙ„</option>
                <option value="top">Ø£Ø¹Ù„Ù‰</option>
                <option value="right">ÙŠÙ…ÙŠÙ†</option>
                <option value="left">ÙŠØ³Ø§Ø±</option>
            </select>
        </div>

        <button class="tool-btn" onclick="rocket.setMode('move')">ğŸ–ï¸</button>
        <span id="page-label" style="font-size:12px; font-weight:bold;">Øµ 1</span>
    </div>

    <div class="footer-rights">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ KAREEM OMAR Â© 2024</div>
    <a href="https://kemo-omar.github.io/Kareem/" target="_blank" class="personal-link">ğŸŒ Kemo Profile</a>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, query, limitToLast, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            isAdmin: false, isSyncing: true, mode: 'move',
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            camera: { x: 0, y: 0, zoom: 1 },
            drawings: {}, history: [], redoStack: [],
            currentColor: '#4361ee', currentPage: 1,

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.setupEvents();
                this.syncData();
                this.render();
                this.startTimer();
                this.makeDraggable(document.getElementById('ruler'));
                this.makeDraggable(document.getElementById('protractor'));
            },

            login(role) {
                const name = document.getElementById('userName').value.trim();
                if(!name) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
                if(role === 'teacher' && prompt("Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…:") !== "123") return;
                
                this.isAdmin = (role === 'teacher');
                if(this.isAdmin) document.getElementById('teacher-controls').style.display = 'flex';
                
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-toolbar').style.display = 'flex';
                document.getElementById('user-tag').innerText = `ğŸ‘¤ ${name}`;
            },

            toggleSync() {
                this.isSyncing = !this.isSyncing;
                const status = document.getElementById('sync-status');
                status.innerText = this.isSyncing ? "ğŸ”„ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø³ØªØ±" : "ğŸš« Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…ØªÙˆÙ‚ÙØ©";
                status.style.background = this.isSyncing ? "#dcfce7" : "#fee2e2";
            },

            moveToolbar(pos) {
                const bar = document.getElementById('main-toolbar');
                bar.style.bottom = bar.style.top = bar.style.left = bar.style.right = 'auto';
                bar.style.transform = 'none';
                if(pos === 'bottom') { bar.style.bottom = '20px'; bar.style.left = '50%'; bar.style.transform = 'translateX(-50%)'; bar.style.flexDirection = 'row'; }
                if(pos === 'top') { bar.style.top = '70px'; bar.style.left = '50%'; bar.style.transform = 'translateX(-50%)'; bar.style.flexDirection = 'row'; }
                if(pos === 'left') { bar.style.left = '20px'; bar.style.top = '50%'; bar.style.transform = 'translateY(-50%)'; bar.style.flexDirection = 'column'; }
                if(pos === 'right') { bar.style.right = '20px'; bar.style.top = '50%'; bar.style.transform = 'translateY(-50%)'; bar.style.flexDirection = 'column'; }
            },

            toggleMinimize() {
                document.getElementById('main-toolbar').classList.toggle('toolbar-minimized');
            },

            undo() {
                const keys = Object.keys(this.drawings);
                if(keys.length > 0) {
                    const lastKey = keys[keys.length-1];
                    this.redoStack.push({key: lastKey, data: this.drawings[lastKey]});
                    remove(ref(db, `board_data/${lastKey}`));
                }
            },

            redo() {
                if(this.redoStack.length > 0) {
                    const item = this.redoStack.pop();
                    set(ref(db, `board_data/${item.key}`), item.data);
                }
            },

            // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ ---
            setupEvents() {
                this.canvas.addEventListener('pointerdown', e => {
                    if(this.mode === 'move' || !this.isAdmin) {
                        this.isDragging = true;
                    } else if(this.isAdmin) {
                        this.isDrawing = true;
                        const pos = this.getPos(e);
                        this.currentPath = [{x: pos.x, y: pos.y}];
                    }
                });

                this.canvas.addEventListener('pointermove', e => {
                    if(this.isDragging) {
                        this.camera.x += e.movementX;
                        this.camera.y += e.movementY;
                    } else if(this.isDrawing) {
                        const pos = this.getPos(e);
                        this.currentPath.push({x: pos.x, y: pos.y});
                    }
                });

                this.canvas.addEventListener('pointerup', () => {
                    if(this.isDrawing) {
                        push(ref(db, 'board_data'), {
                            points: this.currentPath,
                            color: this.currentColor,
                            size: 3,
                            page: this.currentPage
                        });
                        this.redoStack = [];
                    }
                    this.isDrawing = this.isDragging = false;
                });

                window.addEventListener('wheel', e => {
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.camera.zoom *= delta;
                    document.getElementById('zoom-info').innerText = `ğŸ” ${Math.round(this.camera.zoom*100)}%`;
                });
            },

            getPos(e) {
                return {
                    x: (e.clientX - this.camera.x) / this.camera.zoom,
                    y: (e.clientY - this.camera.y) / this.camera.zoom
                };
            },

            syncData() {
                onValue(ref(db, 'board_data'), s => {
                    if(this.isSyncing || this.isAdmin) {
                        this.drawings = s.val() || {};
                    }
                });
            },

            render() {
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                Object.values(this.drawings).forEach(draw => {
                    if(draw.page === this.currentPage) this.drawPath(draw);
                });

                if(this.isDrawing) this.drawPath({points: this.currentPath, color: this.currentColor, size: 3});
                
                requestAnimationFrame(() => this.render());
            },

            drawPath(draw) {
                this.ctx.beginPath();
                this.ctx.strokeStyle = draw.color;
                this.ctx.lineWidth = draw.size;
                this.ctx.lineCap = 'round';
                this.ctx.moveTo(draw.points[0].x, draw.points[0].y);
                draw.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                this.ctx.stroke();
            },

            // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© ---
            toggleGeo(id) {
                const el = document.getElementById(id);
                el.style.display = el.style.display === 'block' ? 'none' : 'block';
                el.style.left = '100px'; el.style.top = '100px';
            },

            makeDraggable(el) {
                let px = 0, py = 0;
                el.onmousedown = (e) => {
                    if(e.target.className === 'resizer') return;
                    e.preventDefault();
                    px = e.clientX; py = e.clientY;
                    document.onmousemove = (e) => {
                        el.style.left = (el.offsetLeft - (px - e.clientX)) + "px";
                        el.style.top = (el.offsetTop - (py - e.clientY)) + "px";
                        px = e.clientX; py = e.clientY;
                    };
                    document.onmouseup = () => document.onmousemove = null;
                };
            },

            startResize(e, id) {
                e.stopPropagation();
                const el = document.getElementById(id);
                const startW = el.offsetWidth;
                const startX = e.clientX;
                const doResize = (ee) => { el.style.width = (startW + (ee.clientX - startX)) + "px"; };
                const stop = () => { window.removeEventListener('mousemove', doResize); };
                window.addEventListener('mousemove', doResize);
                window.addEventListener('mouseup', stop);
            },

            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            updateColor(c) { this.currentColor = c; },
            setMode(m) { this.mode = m; },
            clearBoard() { if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) remove(ref(db, 'board_data')); },
            startTimer() {
                let s = 0; setInterval(() => {
                    s++; let min = Math.floor(s/60), sec = s%60;
                    document.getElementById('timer').innerText = `â³ ${min}:${sec.toString().padStart(2,'0')}`;
                }, 1000);
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
