<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket Turbo V3 - MONSTER ELITE</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.98); --shadow: 0 15px 35px rgba(0,0,0,0.2); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: #e2e8f0; touch-action: none; user-select: none; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; box-shadow: var(--shadow); }

        .top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge { background: var(--glass); padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: bold; pointer-events: auto; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); margin-bottom: 5px; display: inline-flex; align-items: center; gap: 5px; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† */
        #users-list-panel {
            position: absolute; top: 50px; left: 0; background: white; width: 180px; 
            border-radius: 15px; box-shadow: var(--shadow); display: none; 
            padding: 10px; max-height: 300px; overflow-y: auto; z-index: 2005;
        }
        .user-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .user-status { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

        #main-toolbar { 
            position: fixed; background: var(--glass); padding: 12px; border-radius: 24px; 
            box-shadow: var(--shadow); display: none; gap: 10px; align-items: center; z-index: 2000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #fff;
            bottom: 20px; left: 50%; transform: translateX(-50%);
        }
        
        #restore-btn { position: fixed; bottom: 20px; left: 20px; z-index: 3000; display: none; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; box-shadow: var(--shadow); font-size: 20px; }

        .toolbar-vertical { flex-direction: column !important; padding: 15px 10px !important; }
        .toolbar-vertical #teacher-controls { flex-direction: column !important; }

        .tool-btn { 
            width: 46px; height: 46px; border-radius: 14px; border: none; 
            background: #f1f5f9; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative; flex-shrink: 0;
        }
        .tool-btn:hover { background: #e2e8f0; transform: scale(1.05); }
        .tool-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4); }

        .sub-menu {
            position: absolute; bottom: 65px; background: white; padding: 10px; border-radius: 18px;
            display: none; grid-template-columns: repeat(2, 1fr); gap: 8px; box-shadow: var(--shadow); z-index: 2001;
        }
        .show-menu { display: grid; }

        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }

        .geo-tool {
            position: absolute; background: rgba(255, 255, 255, 0.2); border: 2px solid var(--primary);
            backdrop-filter: blur(4px); cursor: move; display: none; z-index: 500; touch-action: none;
        }
        .ruler { height: 60px; width: 400px; background-image: linear-gradient(90deg, #333 2px, transparent 2px); background-size: 20px 30px; background-repeat: repeat-x; background-position: bottom; }
        .protractor { width: 300px; height: 150px; border-radius: 150px 150px 0 0; border-bottom: 3px solid #333; }
        .triangle { width: 200px; height: 200px; clip-path: polygon(0% 100%, 100% 100%, 0% 0%); background: rgba(67, 97, 238, 0.1); }
        .circle-tool { width: 200px; height: 200px; border-radius: 50%; border: 2px dashed var(--primary); }

        .resizer { position: absolute; right: 0; bottom: 0; width: 20px; height: 20px; cursor: nwse-resize; background: var(--primary); border-radius: 50%; pointer-events: auto !important; z-index: 600; }

        #board { background: white; cursor: crosshair; display: block; touch-action: none; }
        .footer-rights { position: fixed; bottom: 5px; left: 10px; font-size: 10px; color: #64748b; z-index: 50; }
        
        .size-slider-cont { display: flex; flex-direction: column; align-items: center; background: #f8fafc; padding: 5px; border-radius: 10px; gap: 2px; }
        .size-slider-cont input { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 8px; height: 80px; }

        .zoom-controls { position: fixed; right: 20px; bottom: 100px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card">
            <h1>ğŸš€ MONSTER ELITE</h1>
            <p>Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…Ø·ÙˆØ±</p>
            <input type="text" id="userName" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px; border:2px solid #f1f5f9; outline:none;" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <button onclick="rocket.login('student')" style="background:#10b981; color:white; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">Ø·Ø§Ù„Ø¨</button>
                <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">Ù…Ø¹Ù„Ù…</button>
            </div>
        </div>
    </div>

    <button id="restore-btn" onclick="rocket.toggleMinimize()">ğŸš€</button>

    <div class="top-bar">
        <div>
            <div class="badge" id="zoom-info">ğŸ” 100%</div>
            <div class="badge" id="sync-status" style="background:#dcfce7">ğŸ”„ Ù…ØªØµÙ„</div>
        </div>
        <div>
            <div class="badge" id="timer">â³ 00:00</div>
            <div style="position: relative; display: inline-block; pointer-events: auto;">
                <button class="badge" onclick="rocket.toggleUsersList()" style="cursor:pointer; border:none;">
                    <span id="user-tag">ğŸ‘¤ Ø²Ø§Ø¦Ø±</span>
                    <span id="online-count" style="background:var(--primary); color:white; border-radius:50%; width:18px; height:18px; font-size:10px; display:flex; align-items:center; justify-content:center; margin-right:5px;">0</span>
                </button>
                <div id="users-list-panel">
                    <div style="font-weight:bold; font-size:12px; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù†:</div>
                    <div id="users-container"></div>
                </div>
            </div>
            <button class="badge" onclick="rocket.toggleFS()" style="pointer-events: auto;">ğŸ“º</button>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="tool-btn" onclick="rocket.adjustZoom(1.1)">â•</button>
        <button class="tool-btn" onclick="rocket.adjustZoom(0.9)">â–</button>
        <button class="tool-btn" onclick="rocket.resetZoom()">ğŸ </button>
    </div>

    <div id="tool-ruler" class="geo-tool ruler"><div class="resizer"></div></div>
    <div id="tool-protractor" class="geo-tool protractor"><div class="resizer"></div></div>
    <div id="tool-triangle" class="geo-tool triangle"><div class="resizer"></div></div>
    <div id="tool-circle" class="geo-tool circle-tool"><div class="resizer"></div></div>

    <div id="main-toolbar">
        <button class="tool-btn" onclick="rocket.toggleMinimize()" title="Ø¥Ø®ÙØ§Ø¡">ğŸ“¦</button>
        
        <div id="teacher-controls" style="display:none; align-items:center; gap:8px;">
            <div style="display:flex; flex-direction:column; gap:4px; background: #f8fafc; padding: 5px; border-radius: 10px;">
                <div style="display:flex; gap:4px;">
                    <div class="color-dot" style="background:#000" onclick="rocket.updateColor('#000')"></div>
                    <div class="color-dot" style="background:#f00" onclick="rocket.updateColor('#f00')"></div>
                </div>
                <div style="display:flex; gap:4px;">
                    <div class="color-dot" style="background:#00b7ff" onclick="rocket.updateColor('#00b7ff')"></div>
                    <div class="color-dot" style="background:#2ed573" onclick="rocket.updateColor('#2ed573')"></div>
                </div>
            </div>

            <div class="size-slider-cont">
                <span style="font-size:10px; font-weight:bold;">ğŸ“</span>
                <input type="range" min="1" max="50" value="3" id="pen-size-slider" oninput="rocket.updateLineWidth(this.value)">
            </div>
            
            <div style="position:relative;">
                <button class="tool-btn active" id="btn-pen" onclick="rocket.toggleSubMenu('pen-menu')">âœï¸</button>
                <div id="pen-menu" class="sub-menu">
                    <button class="tool-btn" onclick="rocket.setMode('pen', 'âœï¸')">âœï¸</button>
                    <button class="tool-btn" onclick="rocket.setMode('marker', 'ğŸ–ï¸')">ğŸ–ï¸</button>
                    <button class="tool-btn" onclick="rocket.setMode('neon', 'ğŸŒŸ')">ğŸŒŸ</button>
                    <button class="tool-btn" onclick="rocket.setMode('brush', 'ğŸ–Œï¸')">ğŸ–Œï¸</button>
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn" onclick="rocket.toggleSubMenu('geo-menu')">ğŸ“</button>
                <div id="geo-menu" class="sub-menu">
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-ruler')">ğŸ“</button>
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-protractor')">ğŸ§­</button>
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-triangle')">ğŸ“</button>
                    <button class="tool-btn" onclick="rocket.toggleGeo('tool-circle')">â­•</button>
                </div>
            </div>

            <button class="tool-btn" id="btn-eraser" onclick="rocket.setMode('eraser')" title="Ù…Ù…Ø­Ø§Ø©">ğŸ§½</button>
            <button class="tool-btn" onclick="rocket.undo()" title="ØªØ±Ø§Ø¬Ø¹">â†©ï¸</button>
            <button class="tool-btn" onclick="rocket.redo()" title="Ø¥Ø¹Ø§Ø¯Ø©">â†ªï¸</button>
            <button class="tool-btn" onclick="rocket.clearBoard()" style="color:red" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„">ğŸ—‘ï¸</button>
            
            <select onchange="rocket.moveToolbar(this.value)" style="border-radius:10px; padding:5px; border:1px solid #ddd; font-family:'Cairo'; outline:none;">
                <option value="bottom">ğŸ‘‡ Ø£Ø³ÙÙ„</option>
                <option value="top">ğŸ‘† Ø£Ø¹Ù„Ù‰</option>
                <option value="right">ğŸ‘‰ ÙŠÙ…ÙŠÙ†</option>
                <option value="left">ğŸ‘ˆ ÙŠØ³Ø§Ø±</option>
            </select>
        </div>

        <button class="tool-btn" onclick="rocket.setMode('move')" id="btn-move" title="ØªØ­Ø±ÙŠÙƒ">ğŸ–ï¸</button>

        <div style="display:flex; align-items:center; background:#f1f5f9; padding:5px 10px; border-radius:15px; gap:8px;">
            <button class="tool-btn" style="width:30px; height:30px; font-size:14px;" onclick="rocket.changePage(-1)">â—€</button>
            <span id="page-label" style="font-weight:bold; min-width:40px; text-align:center;">1</span>
            <button class="tool-btn" style="width:30px; height:30px; font-size:14px;" onclick="rocket.changePage(1)">â–¶</button>
        </div>
    </div>

    <div class="footer-rights">KAREEM OMAR Â© 2026</div>
    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onChildRemoved, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            isAdmin: false, mode: 'move',
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            camera: { x: 0, y: 0, zoom: 1 },
            drawings: {}, redoStack: [], currentColor: '#000', currentLineWidth: 3, currentPage: 1,
            isDrawing: false, isDragging: false, currentPath: [], lastMouse: {x:0, y:0},
            userName: '',

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.setupEvents();
                this.syncData();
                this.render();
                this.startTimer();
                this.syncUsers();
                document.querySelectorAll('.geo-tool').forEach(tool => this.makeDraggable(tool));
                this.makeResizable();
            },

            login(role) {
                const name = document.getElementById('userName').value.trim();
                if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
                if(role === 'teacher' && prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") !== "123") return;
                
                this.userName = name;
                this.isAdmin = (role === 'teacher');
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
                const userRef = push(ref(db, 'online_users'));
                set(userRef, { name: name, role: role });
                onDisconnect(userRef).remove();

                if(this.isAdmin) {
                    document.getElementById('teacher-controls').style.display = 'flex';
                    this.setMode('pen');
                }
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-toolbar').style.display = 'flex';
                document.getElementById('user-tag').innerText = `ğŸ‘¤ ${name}`;
            },

            syncUsers() {
                const usersRef = ref(db, 'online_users');
                onValue(usersRef, (snapshot) => {
                    const users = snapshot.val() || {};
                    const container = document.getElementById('users-container');
                    const countBadge = document.getElementById('online-count');
                    container.innerHTML = '';
                    const usersArray = Object.values(users);
                    countBadge.innerText = usersArray.length;

                    usersArray.forEach(user => {
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.innerHTML = `<span class="user-status"></span> ${user.name} (${user.role === 'teacher' ? 'Ù…Ø¹Ù„Ù…' : 'Ø·Ø§Ù„Ø¨'})`;
                        container.appendChild(div);
                    });
                });
            },

            toggleUsersList() {
                const panel = document.getElementById('users-list-panel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            },

            adjustZoom(factor, centerX, centerY) {
                const oldZoom = this.camera.zoom;
                const newZoom = Math.min(Math.max(oldZoom * factor, 0.1), 10);
                centerX = centerX || window.innerWidth / 2;
                centerY = centerY || window.innerHeight / 2;
                this.camera.x -= (centerX - this.camera.x) * (newZoom / oldZoom - 1);
                this.camera.y -= (centerY - this.camera.y) * (newZoom / oldZoom - 1);
                this.camera.zoom = newZoom;
                document.getElementById('zoom-info').innerText = `ğŸ” ${Math.round(this.camera.zoom * 100)}%`;
            },

            resetZoom() { this.camera = { x: 0, y: 0, zoom: 1 }; document.getElementById('zoom-info').innerText = `ğŸ” 100%`; },

            setupEvents() {
                const handleDown = (e) => {
                    if (e.target.closest('.tool-btn, .sub-menu, .badge, select, input, .geo-tool, .resizer, #users-list-panel')) return;
                    const pos = this.getPos(e);
                    if(this.mode === 'move' || !this.isAdmin) {
                        this.isDragging = true;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    } else {
                        this.isDrawing = true;
                        this.currentPath = [{x: pos.x, y: pos.y}];
                    }
                };

                const handleMove = (e) => {
                    if(this.isDragging) {
                        this.camera.x += e.clientX - this.lastMouse.x;
                        this.camera.y += e.clientY - this.lastMouse.y;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    } else if(this.isDrawing) {
                        const pos = this.getPos(e);
                        this.currentPath.push({x: pos.x, y: pos.y});
                    }
                };

                const handleUp = () => {
                    if(this.isDrawing && this.currentPath.length > 1) {
                        const pathData = {
                            points: this.currentPath,
                            color: this.currentColor,
                            size: this.currentLineWidth,
                            mode: this.mode,
                            page: this.currentPage,
                            time: Date.now()
                        };
                        push(ref(db, 'board_data'), pathData);
                        this.redoStack = [];
                    }
                    this.isDrawing = this.isDragging = false;
                };

                this.canvas.addEventListener('pointerdown', handleDown);
                window.addEventListener('pointermove', handleMove);
                window.addEventListener('pointerup', handleUp);
                window.addEventListener('wheel', e => {
                    e.preventDefault();
                    this.adjustZoom(e.deltaY > 0 ? 0.9 : 1.1, e.clientX, e.clientY);
                }, {passive: false});
            },

            getPos(e) {
                return {
                    x: (e.clientX - this.camera.x) / this.camera.zoom,
                    y: (e.clientY - this.camera.y) / this.camera.zoom
                };
            },

            syncData() {
                const dbRef = ref(db, 'board_data');
                onChildAdded(dbRef, (snapshot) => {
                    this.drawings[snapshot.key] = snapshot.val();
                });
                onChildRemoved(dbRef, (snapshot) => {
                    delete this.drawings[snapshot.key];
                });
            },

            render() {
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                const items = Object.entries(this.drawings).sort((a,b) => a[1].time - b[1].time);
                items.forEach(([id, draw]) => {
                    if(draw.page === this.currentPage) this.drawPath(draw);
                });

                if(this.isDrawing) {
                    this.drawPath({
                        points: this.currentPath, 
                        color: this.currentColor, 
                        size: this.currentLineWidth,
                        mode: this.mode
                    });
                }
                requestAnimationFrame(() => this.render());
            },

            drawPath(draw) {
                if(!draw.points || draw.points.length < 2) return;
                this.ctx.save();
                this.ctx.beginPath();
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                if(draw.mode === 'eraser') {
                    this.ctx.globalCompositeOperation = 'destination-out';
                    this.ctx.strokeStyle = 'rgba(0,0,0,1)';
                } else {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = draw.color;
                }

                this.ctx.lineWidth = draw.size;
                this.ctx.globalAlpha = draw.mode === 'brush' ? 0.5 : 1;
                
                if(draw.mode === 'neon') {
                    this.ctx.shadowBlur = 15;
                    this.ctx.shadowColor = draw.color;
                }

                this.ctx.moveTo(draw.points[0].x, draw.points[0].y);
                for(let i = 1; i < draw.points.length; i++){
                    this.ctx.lineTo(draw.points[i].x, draw.points[i].y);
                }
                this.ctx.stroke();
                this.ctx.restore();
            },

            undo() {
                const keys = Object.keys(this.drawings).filter(k => this.drawings[k].page === this.currentPage);
                if(keys.length > 0) {
                    const lastKey = keys[keys.length-1];
                    this.redoStack.push({key: lastKey, data: this.drawings[lastKey]});
                    remove(ref(db, `board_data/${lastKey}`));
                }
            },

            redo() {
                if(this.redoStack.length > 0) {
                    const item = this.redoStack.pop();
                    set(ref(db, `board_data/${item.key}`), item.data);
                }
            },

            clearBoard() {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) {
                    const keys = Object.keys(this.drawings).filter(k => this.drawings[k].page === this.currentPage);
                    keys.forEach(k => remove(ref(db, `board_data/${k}`)));
                }
            },

            toggleGeo(id) {
                const el = document.getElementById(id);
                el.style.display = (el.style.display === 'block') ? 'none' : 'block';
                el.style.left = '100px'; el.style.top = '100px';
                this.toggleSubMenu('geo-menu');
            },

            makeDraggable(el) {
                let px = 0, py = 0;
                el.onpointerdown = (e) => {
                    if(e.target.className === 'resizer') return;
                    e.stopPropagation();
                    el.setPointerCapture(e.pointerId);
                    px = e.clientX; py = e.clientY;
                    const move = (ee) => {
                        el.style.left = (el.offsetLeft + (ee.clientX - px)) + "px";
                        el.style.top = (el.offsetTop + (ee.clientY - py)) + "px";
                        px = ee.clientX; py = ee.clientY;
                    };
                    const up = () => { 
                        el.releasePointerCapture(e.pointerId);
                        window.removeEventListener('pointermove', move); 
                        window.removeEventListener('pointerup', up); 
                    };
                    window.addEventListener('pointermove', move);
                    window.addEventListener('pointerup', up);
                };
            },

            makeResizable() {
                document.querySelectorAll('.resizer').forEach(resizer => {
                    resizer.onpointerdown = (e) => {
                        e.stopPropagation();
                        const el = resizer.parentElement;
                        el.setPointerCapture(e.pointerId);
                        let sx = e.clientX, sy = e.clientY, sw = el.offsetWidth, sh = el.offsetHeight;
                        const resize = (ee) => {
                            el.style.width = Math.max(50, sw + (ee.clientX - sx)) + "px";
                            el.style.height = Math.max(50, sh + (ee.clientY - sy)) + "px";
                        };
                        const stop = () => { 
                            el.releasePointerCapture(e.pointerId);
                            window.removeEventListener('pointermove', resize); 
                            window.removeEventListener('pointerup', stop); 
                        };
                        window.addEventListener('pointermove', resize);
                        window.addEventListener('pointerup', stop);
                    };
                });
            },

            setMode(m, icon) {
                this.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(m === 'move') {
                    document.getElementById('btn-move').classList.add('active');
                } else if (m === 'eraser') {
                    document.getElementById('btn-eraser').classList.add('active');
                } else {
                    document.getElementById('btn-pen').classList.add('active');
                    if(icon) document.getElementById('btn-pen').innerText = icon;
                }
                document.querySelectorAll('.sub-menu').forEach(m => m.classList.remove('show-menu'));
            },

            toggleSubMenu(id) {
                const menu = document.getElementById(id);
                const isShow = menu.classList.contains('show-menu');
                document.querySelectorAll('.sub-menu').forEach(m => m.classList.remove('show-menu'));
                if(!isShow) menu.classList.add('show-menu');
            },

            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            updateColor(c) { this.currentColor = c; if(this.mode === 'eraser') this.setMode('pen'); },
            updateLineWidth(v) { this.currentLineWidth = parseInt(v); },
            changePage(dir) { this.currentPage = Math.max(1, this.currentPage + dir); document.getElementById('page-label').innerText = this.currentPage; },
            toggleFS() { 
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else {
                    document.exitFullscreen();
                }
            },
            
            toggleMinimize() { 
                const bar = document.getElementById('main-toolbar');
                const rest = document.getElementById('restore-btn');
                if(bar.style.display === 'none') {
                    bar.style.display = 'flex';
                    rest.style.display = 'none';
                } else {
                    bar.style.display = 'none';
                    rest.style.display = 'block';
                }
            },

            moveToolbar(pos) {
                const bar = document.getElementById('main-toolbar');
                bar.classList.remove('toolbar-vertical');
                bar.style.top = bar.style.bottom = bar.style.left = bar.style.right = 'auto';
                bar.style.transform = 'none';

                if(pos === 'bottom' || pos === 'top') {
                    bar.style.left = '50%'; bar.style.transform = 'translateX(-50%)';
                    pos === 'bottom' ? bar.style.bottom = '20px' : bar.style.top = '20px';
                } else {
                    bar.classList.add('toolbar-vertical');
                    bar.style.top = '50%'; bar.style.transform = 'translateY(-50%)';
                    pos === 'right' ? bar.style.right = '20px' : bar.style.left = '20px';
                }
            },
            
            startTimer() { 
                let s = 0; 
                setInterval(() => { 
                    s++; 
                    let m = Math.floor(s/60), sc = s%60; 
                    document.getElementById('timer').innerText = `â³ ${m}:${sc.toString().padStart(2,'0')}`; 
                }, 1000); 
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
